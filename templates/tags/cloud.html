{% extends "base-tailwind.html" %} {% block title %}Tag Cloud - Media Server{%
endblock %} {% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Page Header -->
    <div class="mb-8">
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
        >
            <div>
                <h1 class="text-4xl font-bold text-base</div>-content mb-2">
                    üè∑Ô∏è Tag Cloud
                </h1>
                <p class="text-lg text-base-content/70">
                    Explore all tags by popularity, category, and usage
                </p>
            </div>
            <div class="flex gap-2">
                <a href="/tags" class="btn btn-primary gap-2">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Manage Tags
                </a>
                <a href="/media" class="btn btn-outline gap-2">
                    üé® Browse Media
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Bar -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="stat bg-base-200 rounded-box shadow">
            <div class="stat-title">Total Tags</div>
            <div class="stat-value text-primary" id="totalTagsCount">0</div>
        </div>
        <div class="stat bg-base-200 rounded-box shadow">
            <div class="stat-title">Active Tags</div>
            <div class="stat-value text-success" id="activeTagsCount">0</div>
        </div>
        <div class="stat bg-base-200 rounded-box shadow">
            <div class="stat-title">Total Usage</div>
            <div class="stat-value text-secondary" id="totalUsageCount">0</div>
        </div>
        <div class="stat bg-base-200 rounded-box shadow">
            <div class="stat-title">Categories</div>
            <div class="stat-value text-accent" id="categoriesCount">0</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <div class="flex flex-col sm:flex-row gap-4">
                <select id="cloudSortBy" class="select select-bordered flex-1">
                    <option value="popularity">By Popularity</option>
                    <option value="alphabetical">Alphabetical</option>
                    <option value="recent">Recently Used</option>
                </select>
                <select
                    id="cloudFilterCategory"
                    class="select select-bordered flex-1"
                >
                    <option value="">All Categories</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>
    </div>

    <!-- Tag Cloud -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div
                id="tagCloud"
                class="tag-cloud min-h-[400px] flex flex-wrap justify-center items-center gap-4 p-8 bg-base-200 rounded-lg"
            >
                <!-- Tags will be rendered here -->
                <div class="loading-state">
                    <span class="loading loading-spinner loading-lg"></span>
                    <p class="mt-4 text-base-content/70">Loading tags...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state hidden text-center py-12">
                <div class="text-6xl mb-4">üè∑Ô∏è</div>
                <h3 class="text-2xl font-semibold text-base-content mb-2">
                    No tags found
                </h3>
                <p class="text-base-content/70 mb-6">
                    Create some tags to see them here
                </p>
                <a href="/tags" class="btn btn-primary">Manage Tags</a>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="alert bg-base-200 shadow-lg mt-6">
        <div class="w-full">
            <h3 class="font-semibold mb-3">üí° Size indicates popularity:</h3>
            <div class="flex items-center gap-6 flex-wrap">
                <div class="flex items-center gap-2">
                    <span class="badge badge-sm">1-5</span>
                    <span class="text-xs">Tiny</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge">5-10</span>
                    <span class="text-xs">Small</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge badge-lg">10-20</span>
                    <span class="text-xs">Medium</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge badge-lg text-lg">20-50</span>
                    <span class="text-xs">Large</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge badge-lg text-xl px-6">50+</span>
                    <span class="text-xs">Extra Large</span>
                </div>
            </div>
            <div class="divider"></div>
            <p class="text-sm text-base-content/70">
                üí° <strong>Tip:</strong> Click any tag to view all media items
                with that tag
            </p>
        </div>
    </div>
</div>

<style>
    .tag-cloud {
        position: relative;
    }

    .cloud-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: oklch(var(--b1));
        border: 2px solid transparent;
        border-radius: 9999px;
        font-weight: 600;
        color: oklch(var(--bc));
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .cloud-tag:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        border-color: oklch(var(--p));
        z-index: 10;
    }

    .cloud-tag:active {
        transform: translateY(-2px) scale(1.02);
    }

    /* Size variations */
    .cloud-tag.size-xs {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .cloud-tag.size-sm {
        font-size: 0.875rem;
        padding: 0.375rem 0.625rem;
    }

    .cloud-tag.size-md {
        font-size: 1rem;
        padding: 0.5rem 0.875rem;
    }

    .cloud-tag.size-lg {
        font-size: 1.25rem;
        padding: 0.625rem 1rem;
    }

    .cloud-tag.size-xl {
        font-size: 1.5rem;
        padding: 0.75rem 1.25rem;
    }

    .cloud-tag.size-2xl {
        font-size: 2rem;
        padding: 1rem 1.5rem;
    }

    /* Category colors using DaisyUI theme colors */
    .cloud-tag[data-category="tutorial"] {
        background: oklch(var(--p));
        color: oklch(var(--pc));
    }

    .cloud-tag[data-category="course"] {
        background: oklch(var(--s));
        color: oklch(var(--sc));
    }

    .cloud-tag[data-category="marketing"] {
        background: oklch(var(--a));
        color: oklch(var(--ac));
    }

    .cloud-tag[data-category="product"] {
        background: oklch(var(--su));
        color: oklch(var(--suc));
    }

    .cloud-tag[data-category="department"] {
        background: oklch(var(--wa));
        color: oklch(var(--wac));
    }

    .cloud-tag .usage-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.5rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
    }

    /* Animation for tag appearance */
    @keyframes tagFadeIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .cloud-tag {
        animation: tagFadeIn 0.3s ease-out;
    }

    /* Stagger animation delay */
    .cloud-tag:nth-child(1) {
        animation-delay: 0.05s;
    }
    .cloud-tag:nth-child(2) {
        animation-delay: 0.1s;
    }
    .cloud-tag:nth-child(3) {
        animation-delay: 0.15s;
    }
    .cloud-tag:nth-child(4) {
        animation-delay: 0.2s;
    }
    .cloud-tag:nth-child(5) {
        animation-delay: 0.25s;
    }
    .cloud-tag:nth-child(n + 6) {
        animation-delay: 0.3s;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .tag-cloud {
            padding: 1rem;
            gap: 0.5rem;
        }

        .cloud-tag {
            font-size: 0.875rem !important;
            padding: 0.375rem 0.75rem !important;
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .cloud-tag {
            animation: none;
            transition: none;
        }
    }
</style>

<script>
    // Tag Cloud State
    let tagCloudData = [];
    let currentCloudSort = "popularity";
    let currentCloudCategory = "";

    // Initialize tag cloud on page load
    document.addEventListener("DOMContentLoaded", initTagCloud);

    async function initTagCloud() {
        try {
            const [tagsResponse, statsResponse, categoriesResponse] =
                await Promise.all([
                    fetch("/api/tags"),
                    fetch("/api/tags/stats"),
                    fetch("/api/tags/categories"),
                ]);

            const tagsData = await tagsResponse.json();
            const statsData = await statsResponse.json();
            const categoriesData = await categoriesResponse.json();

            tagCloudData = tagsData.tags || [];

            updateStats(statsData);
            populateCategories(categoriesData.categories || []);
            renderTagCloud(tagCloudData);
            attachCloudEventListeners();
        } catch (error) {
            console.error("Error initializing tag cloud:", error);
            showEmptyState();
        }
    }

    function attachCloudEventListeners() {
        document
            .getElementById("cloudSortBy")
            ?.addEventListener("change", (e) => {
                currentCloudSort = e.target.value;
                renderTagCloud(filterAndSortTags());
            });

        document
            .getElementById("cloudFilterCategory")
            ?.addEventListener("change", (e) => {
                currentCloudCategory = e.target.value;
                renderTagCloud(filterAndSortTags());
            });
    }

    function updateStats(stats) {
        document.getElementById("totalTagsCount").textContent =
            stats.total_tags || 0;
        document.getElementById("activeTagsCount").textContent =
            stats.tags_in_use || 0;
        document.getElementById("totalUsageCount").textContent =
            stats.total_usage || 0;
        document.getElementById("categoriesCount").textContent =
            stats.categories || 0;
    }

    function populateCategories(categories) {
        const select = document.getElementById("cloudFilterCategory");
        categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });
    }

    function filterAndSortTags() {
        let filtered = [...tagCloudData];

        if (currentCloudCategory) {
            filtered = filtered.filter(
                (tag) => tag.category === currentCloudCategory,
            );
        }

        if (currentCloudSort === "alphabetical") {
            filtered.sort((a, b) => a.name.localeCompare(b.name));
        } else if (currentCloudSort === "recent") {
            filtered.sort(
                (a, b) => new Date(b.created_at) - new Date(a.created_at),
            );
        } else {
            filtered.sort(
                (a, b) => (b.usage_count || 0) - (a.usage_count || 0),
            );
        }

        return filtered;
    }

    function getTagSize(usageCount) {
        if (usageCount >= 100) return "size-2xl";
        if (usageCount >= 50) return "size-xl";
        if (usageCount >= 20) return "size-lg";
        if (usageCount >= 10) return "size-md";
        if (usageCount >= 5) return "size-sm";
        return "size-xs";
    }

    function renderTagCloud(tags) {
        const container = document.getElementById("tagCloud");
        const emptyState = document.getElementById("emptyState");

        if (tags.length === 0) {
            showEmptyState();
            return;
        }

        emptyState.classList.add("hidden");

        container.innerHTML = tags
            .map((tag) => {
                const size = getTagSize(tag.usage_count || 0);
                const icon = tag.icon || "üè∑Ô∏è";
                const category = tag.category
                    ? tag.category.toLowerCase().replace(/\s+/g, "-")
                    : "";

                return `
                <a
                    href="/media?tag=${tag.slug}"
                    class="cloud-tag ${size}"
                    data-category="${category}"
                    title="${escapeHtml(tag.description || tag.name)} - ${tag.usage_count || 0} uses"
                >
                    <span>${icon}</span>
                    <span>${escapeHtml(tag.name)}</span>
                    <span class="usage-badge">${tag.usage_count || 0}</span>
                </a>
            `;
            })
            .join("");
    }

    function showEmptyState() {
        document.getElementById("tagCloud").innerHTML = "";
        document.getElementById("emptyState").classList.remove("hidden");
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
