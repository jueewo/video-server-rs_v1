<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tag Management - Media Server</title>
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link rel="stylesheet" href="/static/css/tag-picker.css">
    <style>
        .tag-card {
            transition: all 0.2s ease;
        }
        .tag-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .color-swatch {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            border: 2px solid #e5e7eb;
        }
        .stats-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-8">
                    <a href="/" class="text-xl font-bold text-gray-900">Media Server</a>
                    <div class="hidden md:flex gap-4">
                        <a href="/videos" class="text-gray-600 hover:text-gray-900">Videos</a>
                        <a href="/images" class="text-gray-600 hover:text-gray-900">Images</a>
                        <a href="/documents" class="text-gray-600 hover:text-gray-900">Documents</a>
                        <a href="/media" class="text-gray-600 hover:text-gray-900">All Media</a>
                        <a href="/tags" class="text-indigo-600 font-semibold">Tags</a>
                    </div>
                </div>
                <button id="createTagBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    + New Tag
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <!-- Header with Stats -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Tag Management</h1>
            <p class="text-gray-600 mb-6">Organize and manage tags for your media library</p>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="text-2xl font-bold text-indigo-600" id="totalTags">0</div>
                    <div class="text-sm text-gray-600">Total Tags</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="text-2xl font-bold text-green-600" id="usedTags">0</div>
                    <div class="text-sm text-gray-600">Tags in Use</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="text-2xl font-bold text-purple-600" id="totalCategories">0</div>
                    <div class="text-sm text-gray-600">Categories</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="text-2xl font-bold text-orange-600" id="totalUsage">0</div>
                    <div class="text-sm text-gray-600">Total Usage</div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search tags..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                </div>
                <div class="w-full md:w-48">
                    <select id="categoryFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="w-full md:w-48">
                    <select id="sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="name">Sort by Name</option>
                        <option value="usage">Sort by Usage</option>
                        <option value="recent">Sort by Recent</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tags Grid -->
        <div id="tagsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Tags will be loaded here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-indigo-600"></div>
            <p class="mt-4 text-gray-600">Loading tags...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üè∑Ô∏è</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No tags yet</h3>
            <p class="text-gray-600 mb-6">Create your first tag to get started organizing your media</p>
            <button onclick="openCreateModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                Create First Tag
            </button>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="tagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Create Tag</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>
            </div>

            <form id="tagForm" class="p-6 space-y-6">
                <input type="hidden" id="tagId" name="id">
                <input type="hidden" id="originalSlug" name="originalSlug">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tag Name *
                    </label>
                    <input
                        type="text"
                        id="tagName"
                        name="name"
                        required
                        placeholder="e.g., Tutorial, Marketing, Product Launch"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                    <p class="mt-1 text-sm text-gray-500">Display name for the tag</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Slug
                    </label>
                    <input
                        type="text"
                        id="tagSlug"
                        name="slug"
                        placeholder="Auto-generated from name"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50"
                        readonly
                    />
                    <p class="mt-1 text-sm text-gray-500">URL-friendly identifier (auto-generated)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea
                        id="tagDescription"
                        name="description"
                        rows="3"
                        placeholder="Brief description of what this tag is used for..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Color
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="color"
                                id="tagColor"
                                name="color"
                                value="#667eea"
                                class="h-10 w-20 border border-gray-300 rounded cursor-pointer"
                            />
                            <input
                                type="text"
                                id="tagColorHex"
                                placeholder="#667eea"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Visual color in UI</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Icon/Emoji
                        </label>
                        <input
                            type="text"
                            id="tagIcon"
                            name="icon"
                            placeholder="üè∑Ô∏è üé¨ üìö üé®"
                            maxlength="2"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                        <p class="mt-1 text-sm text-gray-500">Optional emoji or icon</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Category
                    </label>
                    <input
                        type="text"
                        id="tagCategory"
                        name="category"
                        placeholder="e.g., Content Type, Department, Topic"
                        list="categoryList"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                    <datalist id="categoryList">
                        <!-- Populated dynamically -->
                    </datalist>
                    <p class="mt-1 text-sm text-gray-500">Group related tags together</p>
                </div>

                <div class="flex gap-4 pt-4 border-t border-gray-200">
                    <button
                        type="submit"
                        class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
                    >
                        Save Tag
                    </button>
                    <button
                        type="button"
                        onclick="closeModal()"
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Delete Tag</h3>
                        <p class="text-sm text-gray-600">Are you sure you want to delete this tag?</p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-gray-700">
                        Tag: <span id="deleteTagName" class="font-semibold"></span>
                    </p>
                    <p class="text-sm text-gray-700 mt-1">
                        Used in <span id="deleteTagUsage" class="font-semibold">0</span> items
                    </p>
                </div>

                <p class="text-sm text-red-600 mb-6">
                    This will remove the tag from all media items. This action cannot be undone.
                </p>

                <div class="flex gap-3">
                    <button
                        id="confirmDeleteBtn"
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium"
                    >
                        Delete Tag
                    </button>
                    <button
                        onclick="closeDeleteModal()"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in">
        <p id="toastMessage"></p>
    </div>

    <script>
        // State
        let allTags = [];
        let currentEditSlug = null;
        let currentDeleteSlug = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTags();
            loadStats();
            loadCategories();
            attachEventListeners();
        });

        function attachEventListeners() {
            document.getElementById('createTagBtn').addEventListener('click', openCreateModal);
            document.getElementById('tagForm').addEventListener('submit', handleSubmit);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
            document.getElementById('searchInput').addEventListener('input', filterTags);
            document.getElementById('categoryFilter').addEventListener('change', filterTags);
            document.getElementById('sortBy').addEventListener('change', filterTags);

            // Auto-generate slug from name
            document.getElementById('tagName').addEventListener('input', (e) => {
                const slug = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                document.getElementById('tagSlug').value = slug;
            });

            // Sync color picker with hex input
            document.getElementById('tagColor').addEventListener('input', (e) => {
                document.getElementById('tagColorHex').value = e.target.value;
            });
            document.getElementById('tagColorHex').addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    document.getElementById('tagColor').value = e.target.value;
                }
            });
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                const data = await response.json();
                allTags = data.tags || [];
                renderTags(allTags);

                document.getElementById('loadingState').classList.add('hidden');
                if (allTags.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                showToast('Failed to load tags', 'error');
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/tags/stats');
                const stats = await response.json();

                document.getElementById('totalTags').textContent = stats.total_tags || 0;
                document.getElementById('usedTags').textContent = stats.tags_in_use || 0;
                document.getElementById('totalCategories').textContent = stats.categories || 0;
                document.getElementById('totalUsage').textContent = stats.total_usage || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/tags/categories');
                const data = await response.json();
                const categories = data.categories || [];

                const filterSelect = document.getElementById('categoryFilter');
                const datalist = document.getElementById('categoryList');

                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filterSelect.appendChild(option.cloneNode(true));
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderTags(tags) {
            const container = document.getElementById('tagsContainer');

            if (tags.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No tags found</div>';
                return;
            }

            container.innerHTML = tags.map(tag => `
                <div class="tag-card bg-white p-6 rounded-lg shadow-sm border-l-4" style="border-color: ${tag.color || '#667eea'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            ${tag.icon ? `<span class="text-2xl">${tag.icon}</span>` : ''}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(tag.name)}</h3>
                                <p class="text-sm text-gray-500">${tag.slug}</p>
                            </div>
                        </div>
                        <div class="color-swatch" style="background-color: ${tag.color || '#667eea'}"></div>
                    </div>

                    ${tag.description ? `
                        <p class="text-sm text-gray-600 mb-4">${escapeHtml(tag.description)}</p>
                    ` : ''}

                    <div class="flex items-center justify-between mb-4">
                        <span class="stats-badge">
                            üìä ${tag.usage_count || 0} uses
                        </span>
                        ${tag.category ? `
                            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">
                                ${escapeHtml(tag.category)}
                            </span>
                        ` : ''}
                    </div>

                    <div class="flex gap-2">
                        <button
                            onclick="editTag('${tag.slug}')"
                            class="flex-1 px-4 py-2 text-sm bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition font-medium"
                        >
                            Edit
                        </button>
                        <button
                            onclick="deleteTag('${tag.slug}')"
                            class="px-4 py-2 text-sm border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterTags() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = allTags.filter(tag => {
                const matchesSearch = !search ||
                    tag.name.toLowerCase().includes(search) ||
                    tag.slug.toLowerCase().includes(search) ||
                    (tag.description && tag.description.toLowerCase().includes(search));

                const matchesCategory = !category || tag.category === category;

                return matchesSearch && matchesCategory;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'usage') {
                    return (b.usage_count || 0) - (a.usage_count || 0);
                } else if (sortBy === 'recent') {
                    return new Date(b.created_at) - new Date(a.created_at);
                } else {
                    return a.name.localeCompare(b.name);
                }
            });

            renderTags(filtered);
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Tag';
            document.getElementById('tagForm').reset();
            document.getElementById('tagId').value = '';
            document.getElementById('originalSlug').value = '';
            document.getElementById('tagColor').value = '#667eea';
            document.getElementById('tagColorHex').value = '#667eea';
            currentEditSlug = null;
            document.getElementById('tagModal').classList.remove('hidden');
        }

        async function editTag(slug) {
            try {
                const response = await fetch(`/api/tags/${slug}`);
                const tag = await response.json();

                document.getElementById('modalTitle').textContent = 'Edit Tag';
                document.getElementById('tagId').value = tag.id;
                document.getElementById('originalSlug').value = tag.slug;
                document.getElementById('tagName').value = tag.name;
                document.getElementById('tagSlug').value = tag.slug;
                document.getElementById('tagDescription').value = tag.description || '';
                document.getElementById('tagColor').value = tag.color || '#667eea';
                document.getElementById('tagColorHex').value = tag.color || '#667eea';
                document.getElementById('tagIcon').value = tag.icon || '';
                document.getElementById('tagCategory').value = tag.category || '';

                currentEditSlug = slug;
                document.getElementById('tagModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading tag:', error);
                showToast('Failed to load tag', 'error');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('tagName').value,
                slug: document.getElementById('tagSlug').value,
                description: document.getElementById('tagDescription').value || null,
                color: document.getElementById('tagColor').value,
                icon: document.getElementById('tagIcon').value || null,
                category: document.getElementById('tagCategory').value || null
            };

            try {
                let response;
                if (currentEditSlug) {
                    response = await fetch(`/api/tags/${currentEditSlug}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch('/api/tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    showToast(currentEditSlug ? 'Tag updated successfully' : 'Tag created successfully', 'success');
                    closeModal();
                    loadTags();
                    loadStats();
                    loadCategories();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to save tag', 'error');
                }
            } catch (error) {
                console.error('Error saving tag:', error);
                showToast('Failed to save tag', 'error');
            }
        }

        function deleteTag(slug) {
            const tag = allTags.find(t => t.slug === slug);
            if (!tag) return;

            document.getElementById('deleteTagName').textContent = tag.name;
            document.getElementById('deleteTagUsage').textContent = tag.usage_count || 0;
            currentDeleteSlug = slug;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        async function confirmDelete() {
            if (!currentDeleteSlug) return;

            try {
                const response = await fetch(`/api/tags/${currentDeleteSlug}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Tag deleted successfully', 'success');
                    closeDeleteModal();
                    loadTags();
                    loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to delete tag', 'error');
                }
            } catch (error) {
                console.error('Error deleting tag:', error);
                showToast('Failed to delete tag', 'error');
            }
        }

        function closeModal() {
            document.getElementById('tagModal').classList.add('hidden');
            currentEditSlug = null;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            currentDeleteSlug = null;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            if (type === 'error') {
                toast.classList.add('bg-red-600');
                toast.classList.remove('bg-gray-900');
            } else {
                toast.classList.add('bg-gray-900');
                toast.classList.remove('bg-red-600');
            }

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
