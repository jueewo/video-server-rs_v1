{% extends "base-tailwind.html" %} {% block title %}Upload Image - Media
Server{% endblock %} {% block extra_head %}
<style>
    .drag-over {
        @apply border-primary bg-primary/10;
    }

    .upload-progress {
        transition: width 0.3s ease;
    }

    .image-preview {
        max-height: 500px;
    }

    .tag-input-wrapper {
        position: relative;
    }

    .tag-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 2px solid #ddd;
    }
</style>
{% endblock %} {% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl" x-data="imageUpload()">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <a href="/images" class="btn btn-ghost btn-sm gap-2">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                >
                    <path
                        fill-rule="evenodd"
                        d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                        clip-rule="evenodd"
                    />
                </svg>
                Back to Gallery
            </a>
        </div>
        <h1 class="text-4xl font-bold text-base-content mb-2">
            üñºÔ∏è Upload Images
        </h1>
        <p class="text-lg text-base-content/70">
            Share your photos and graphics
        </p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8">
        <ul class="steps steps-horizontal w-full">
            <li class="step" :class="step >= 1 ? 'step-primary' : ''">
                Select Images
            </li>
            <li class="step" :class="step >= 2 ? 'step-primary' : ''">
                Add Details
            </li>
            <li class="step" :class="step >= 3 ? 'step-primary' : ''">
                Metadata & Tags
            </li>
            <li class="step" :class="step >= 4 ? 'step-primary' : ''">
                Review & Upload
            </li>
        </ul>
    </div>

    <form @submit.prevent="handleSubmit" class="space-y-6">
        <!-- Step 1: File Selection -->
        <div x-show="step === 1" class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">Choose Your Images</h2>

                <!-- Drag and Drop Zone -->
                <div
                    class="border-4 border-dashed border-base-300 rounded-xl p-12 text-center transition-all duration-300"
                    :class="{ 'drag-over': isDragging }"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleDrop"
                    x-show="selectedFiles.length === 0"
                >
                    <div class="text-6xl mb-4">üì∏</div>
                    <h3 class="text-2xl font-bold mb-2">
                        Drag & Drop Your Images
                    </h3>
                    <p class="text-base-content/60 mb-4">
                        or click to browse (multiple files supported)
                    </p>
                    <input
                        type="file"
                        id="imageFiles"
                        accept="image/*"
                        multiple
                        @change="handleFileSelect"
                        class="hidden"
                    />
                    <label
                        for="imageFiles"
                        class="btn btn-primary btn-lg gap-2"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"
                            />
                        </svg>
                        Choose Files
                    </label>
                    <p class="text-sm text-base-content/50 mt-4">
                        Supported: JPG, PNG, GIF, WebP, BMP (Max 10MB per file)
                    </p>
                </div>

                <!-- File Preview Grid -->
                <div x-show="selectedFiles.length > 0" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">
                            <span x-text="selectedFiles.length"></span>
                            image<span x-show="selectedFiles.length !== 1"
                                >s</span
                            >
                            selected
                        </h3>
                        <label
                            for="imageFiles"
                            class="btn btn-outline btn-sm gap-2"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                />
                            </svg>
                            Add More
                        </label>
                    </div>

                    <!-- Thumbnail Grid -->
                    <div class="thumbnail-grid">
                        <template
                            x-for="(file, index) in selectedFiles"
                            :key="index"
                        >
                            <div class="card bg-base-200 shadow-md">
                                <figure class="relative">
                                    <img
                                        :src="file.preview"
                                        :alt="file.name"
                                        class="w-full h-40 object-cover"
                                    />
                                    <button
                                        type="button"
                                        @click="removeFile(index)"
                                        class="btn btn-circle btn-sm btn-error absolute top-2 right-2"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                clip-rule="evenodd"
                                            />
                                        </svg>
                                    </button>
                                </figure>
                                <div class="card-body p-3">
                                    <p
                                        class="text-xs truncate font-medium"
                                        x-text="file.name"
                                    ></p>
                                    <p
                                        class="text-xs text-base-content/60"
                                        x-text="formatFileSize(file.size)"
                                    ></p>
                                    <div
                                        class="badge badge-sm"
                                        x-show="file.metadata.width"
                                    >
                                        <span
                                            x-text="file.metadata.width"
                                        ></span
                                        >√ó<span
                                            x-text="file.metadata.height"
                                        ></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button
                            type="button"
                            @click="clearFiles"
                            class="btn btn-outline gap-2"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                            Clear All
                        </button>
                        <button
                            type="button"
                            @click="step = 2"
                            class="btn btn-primary flex-1 gap-2"
                        >
                            Next: Add Details
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Basic Details -->
        <div x-show="step === 2" class="space-y-6">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        üìù Basic Information
                    </h2>

                    <!-- Current Image Preview -->
                    <div class="flex items-start gap-6 mb-6">
                        <div class="w-1/3">
                            <img
                                :src="currentFile?.preview"
                                :alt="currentFile?.name"
                                class="w-full rounded-lg shadow-lg"
                            />
                            <div class="mt-2 text-sm text-center">
                                <span
                                    class="font-bold"
                                    x-text="currentImageIndex + 1"
                                ></span>
                                of <span x-text="selectedFiles.length"></span>
                            </div>
                        </div>

                        <div class="flex-1 space-y-4">
                            <!-- Title -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold"
                                        >Title *</span
                                    >
                                    <span
                                        class="label-text-alt"
                                        x-text="currentFormData.title.length + '/100'"
                                    ></span>
                                </label>
                                <input
                                    type="text"
                                    x-model="currentFormData.title"
                                    placeholder="Enter a descriptive title"
                                    class="input input-bordered w-full"
                                    maxlength="100"
                                    required
                                />
                            </div>

                            <!-- Slug (auto-generated) -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold"
                                        >URL Slug *</span
                                    >
                                    <span class="label-text-alt text-info"
                                        >Auto-generated</span
                                    >
                                </label>
                                <input
                                    type="text"
                                    x-model="currentFormData.slug"
                                    placeholder="url-friendly-slug"
                                    class="input input-bordered w-full"
                                    pattern="[a-z0-9-]+"
                                    required
                                />
                            </div>

                            <!-- Description -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold"
                                        >Description</span
                                    >
                                    <span
                                        class="label-text-alt"
                                        x-text="currentFormData.description.length + '/500'"
                                    ></span>
                                </label>
                                <textarea
                                    x-model="currentFormData.description"
                                    placeholder="Describe this image..."
                                    class="textarea textarea-bordered h-24"
                                    maxlength="500"
                                ></textarea>
                            </div>

                            <!-- Alt Text (Accessibility) -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold"
                                        >Alt Text *</span
                                    >
                                    <span class="label-text-alt"
                                        >For accessibility</span
                                    >
                                </label>
                                <input
                                    type="text"
                                    x-model="currentFormData.altText"
                                    placeholder="Describe the image for screen readers"
                                    class="input input-bordered w-full"
                                    maxlength="200"
                                    required
                                />
                            </div>

                            <!-- Visibility -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold"
                                        >Visibility *</span
                                    >
                                </label>
                                <div class="flex gap-4">
                                    <label class="label cursor-pointer gap-2">
                                        <input
                                            type="radio"
                                            x-model="currentFormData.isPublic"
                                            value="true"
                                            class="radio radio-primary"
                                            checked
                                        />
                                        <span>Public</span>
                                    </label>
                                    <label class="label cursor-pointer gap-2">
                                        <input
                                            type="radio"
                                            x-model="currentFormData.isPublic"
                                            value="false"
                                            class="radio radio-primary"
                                        />
                                        <span>Private</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div
                        class="flex justify-between items-center pt-4 border-t"
                    >
                        <button
                            type="button"
                            @click="step = 1"
                            class="btn btn-outline gap-2"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                            Back
                        </button>

                        <div class="flex gap-2">
                            <button
                                type="button"
                                @click="previousImage"
                                class="btn btn-outline btn-sm"
                                :disabled="currentImageIndex === 0"
                            >
                                Previous Image
                            </button>
                            <button
                                type="button"
                                @click="nextImage"
                                class="btn btn-outline btn-sm"
                                :disabled="currentImageIndex >= selectedFiles.length - 1"
                            >
                                Next Image
                            </button>
                        </div>

                        <button
                            type="button"
                            @click="saveCurrentAndProceed"
                            class="btn btn-primary gap-2"
                        >
                            <span
                                x-show="currentImageIndex < selectedFiles.length - 1"
                                >Next Image & Continue</span
                            >
                            <span
                                x-show="currentImageIndex >= selectedFiles.length - 1"
                                >Next: Metadata</span
                            >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Metadata & Tags -->
        <div x-show="step === 3" class="space-y-6">
            <!-- Apply to All Notice -->
            <div class="alert alert-info">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span
                    >Settings on this page will be applied to all selected
                    images</span
                >
            </div>

            <!-- Organization -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üìÇ Organization</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Category -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >Category</span
                                >
                            </label>
                            <select
                                x-model="globalMetadata.category"
                                class="select select-bordered w-full"
                            >
                                <option value="">Select category...</option>
                                <option value="photos">Photos</option>
                                <option value="graphics">Graphics</option>
                                <option value="screenshots">Screenshots</option>
                                <option value="diagrams">Diagrams</option>
                                <option value="logos">Logos</option>
                                <option value="icons">Icons</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Subcategory -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >Subcategory</span
                                >
                            </label>
                            <input
                                type="text"
                                x-model="globalMetadata.subcategory"
                                placeholder="e.g., portraits, landscapes..."
                                class="input input-bordered w-full"
                            />
                        </div>

                        <!-- Collection -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >Collection</span
                                >
                            </label>
                            <input
                                type="text"
                                x-model="globalMetadata.collection"
                                placeholder="Group related images..."
                                class="input input-bordered w-full"
                            />
                        </div>

                        <!-- Series -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >Series</span
                                >
                            </label>
                            <input
                                type="text"
                                x-model="globalMetadata.series"
                                placeholder="Part of a series..."
                                class="input input-bordered w-full"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üè∑Ô∏è Tags</h2>

                    <!-- Tag Input -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold"
                                >Add Tags</span
                            >
                            <span class="label-text-alt"
                                >Press Enter or comma to add</span
                            >
                        </label>
                        <div class="tag-input-wrapper">
                            <input
                                type="text"
                                x-model="tagInput"
                                @keydown.enter.prevent="addTag"
                                @keydown.comma.prevent="addTag"
                                @input="searchTags"
                                placeholder="Type to search or create tags..."
                                class="input input-bordered w-full"
                            />
                            <!-- Tag Suggestions -->
                            <div
                                x-show="tagSuggestions.length > 0"
                                class="tag-suggestions bg-base-100 border border-base-300 rounded-lg shadow-lg mt-2"
                            >
                                <template
                                    x-for="suggestion in tagSuggestions"
                                    :key="suggestion"
                                >
                                    <button
                                        type="button"
                                        @click="selectTag(suggestion)"
                                        class="w-full text-left px-4 py-2 hover:bg-base-200 transition-colors"
                                    >
                                        <span x-text="suggestion"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Tags -->
                    <div
                        class="flex flex-wrap gap-2 mt-4"
                        x-show="globalMetadata.tags.length > 0"
                    >
                        <template
                            x-for="(tag, index) in globalMetadata.tags"
                            :key="index"
                        >
                            <div class="badge badge-lg badge-primary gap-2">
                                <span x-text="tag"></span>
                                <button
                                    type="button"
                                    @click="removeTag(index)"
                                    class="btn btn-ghost btn-xs btn-circle"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-3 w-3"
                                        viewBox="0 0 20 20"
                                        fill="currentColor"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Popular Tags -->
                    <div class="mt-6">
                        <p class="text-sm font-semibold mb-2">Popular Tags:</p>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in popularTags" :key="tag">
                                <button
                                    type="button"
                                    @click="selectTag(tag)"
                                    class="badge badge-outline badge-lg hover:badge-primary transition-colors"
                                    x-text="tag"
                                ></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Copyright & Licensing -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        ‚öñÔ∏è Copyright & Licensing
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >Copyright Holder</span
                                >
                            </label>
                            <input
                                type="text"
                                x-model="globalMetadata.copyrightHolder"
                                placeholder="e.g., Your Name or Company"
                                class="input input-bordered w-full"
                            />
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold"
                                    >License</span
                                >
                            </label>
                            <select
                                x-model="globalMetadata.license"
                                class="select select-bordered w-full"
                            >
                                <option value="">Select license...</option>
                                <option value="All Rights Reserved">
                                    All Rights Reserved
                                </option>
                                <option value="CC BY 4.0">
                                    Creative Commons BY 4.0
                                </option>
                                <option value="CC BY-SA 4.0">
                                    Creative Commons BY-SA 4.0
                                </option>
                                <option value="CC BY-NC 4.0">
                                    Creative Commons BY-NC 4.0
                                </option>
                                <option value="CC0 1.0">
                                    Public Domain (CC0)
                                </option>
                                <option value="MIT">MIT License</option>
                            </select>
                        </div>
                    </div>

                    <!-- Permissions -->
                    <div class="flex flex-wrap gap-4 mt-4">
                        <label class="label cursor-pointer gap-2">
                            <input
                                type="checkbox"
                                x-model="globalMetadata.allowDownload"
                                class="checkbox checkbox-primary"
                            />
                            <span class="label-text">Allow downloads</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input
                                type="checkbox"
                                x-model="globalMetadata.matureContent"
                                class="checkbox checkbox-warning"
                            />
                            <span class="label-text">Mature content</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input
                                type="checkbox"
                                x-model="globalMetadata.featured"
                                class="checkbox checkbox-secondary"
                            />
                            <span class="label-text">Mark as featured</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between">
                <button
                    type="button"
                    @click="step = 2; currentImageIndex = 0"
                    class="btn btn-outline gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Back to Details
                </button>
                <button
                    type="button"
                    @click="step = 4"
                    class="btn btn-primary gap-2"
                >
                    Review & Upload
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                            clip-rule="evenodd"
                        />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Step 4: Review & Upload -->
        <div x-show="step === 4" class="space-y-6">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">‚úÖ Review & Upload</h2>

                    <!-- Summary Stats -->
                    <div
                        class="stats stats-vertical lg:stats-horizontal shadow w-full mb-6"
                    >
                        <div class="stat">
                            <div class="stat-title">Images</div>
                            <div
                                class="stat-value text-primary"
                                x-text="selectedFiles.length"
                            ></div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Total Size</div>
                            <div
                                class="stat-value text-secondary"
                                x-text="formatFileSize(totalSize)"
                            ></div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Tags</div>
                            <div
                                class="stat-value text-accent"
                                x-text="globalMetadata.tags.length"
                            ></div>
                        </div>
                    </div>

                    <!-- Images List -->
                    <div class="space-y-4">
                        <template
                            x-for="(file, index) in selectedFiles"
                            :key="index"
                        >
                            <div class="card card-side bg-base-200 shadow-sm">
                                <figure class="w-32">
                                    <img
                                        :src="file.preview"
                                        :alt="file.formData.title"
                                        class="w-full h-full object-cover"
                                    />
                                </figure>
                                <div class="card-body">
                                    <h3
                                        class="card-title text-lg"
                                        x-text="file.formData.title"
                                    ></h3>
                                    <p
                                        class="text-sm text-base-content/70"
                                        x-text="file.formData.slug"
                                    ></p>
                                    <div class="flex gap-2 flex-wrap">
                                        <div
                                            class="badge badge-sm"
                                            x-text="file.metadata.width + '√ó' + file.metadata.height"
                                        ></div>
                                        <div
                                            class="badge badge-sm"
                                            x-text="formatFileSize(file.size)"
                                        ></div>
                                        <div
                                            class="badge badge-sm"
                                            x-text="file.formData.isPublic === 'true' ? 'Public' : 'Private'"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Upload Progress -->
                    <div x-show="uploading" class="mt-6">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold"
                                >Uploading...</span
                            >
                            <span
                                class="text-sm"
                                x-text="uploadProgress + '%'"
                            ></span>
                        </div>
                        <progress
                            class="progress progress-primary w-full"
                            :value="uploadProgress"
                            max="100"
                        ></progress>
                        <p
                            class="text-sm text-center mt-2"
                            x-text="uploadStatus"
                        ></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between mt-6" x-show="!uploading">
                        <button
                            type="button"
                            @click="step = 3"
                            class="btn btn-outline gap-2"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                            Back to Metadata
                        </button>
                        <button
                            type="submit"
                            class="btn btn-primary btn-lg gap-2"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"
                                />
                                <path
                                    d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"
                                />
                            </svg>
                            Upload
                            <span x-text="selectedFiles.length"></span>
                            Image<span x-show="selectedFiles.length !== 1"
                                >s</span
                            >
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function imageUpload() {
        return {
            step: 1,
            isDragging: false,
            selectedFiles: [],
            currentImageIndex: 0,
            currentFormData: {
                title: "",
                slug: "",
                description: "",
                altText: "",
                isPublic: "true",
            },
            globalMetadata: {
                category: "",
                subcategory: "",
                collection: "",
                series: "",
                tags: [],
                copyrightHolder: "",
                license: "",
                allowDownload: true,
                matureContent: false,
                featured: false,
            },
            tagInput: "",
            tagSuggestions: [],
            popularTags: [
                "photo",
                "design",
                "screenshot",
                "logo",
                "icon",
                "diagram",
                "art",
                "nature",
                "portrait",
            ],
            uploading: false,
            uploadProgress: 0,
            uploadStatus: "",

            get currentFile() {
                return this.selectedFiles[this.currentImageIndex];
            },

            get totalSize() {
                return this.selectedFiles.reduce(
                    (sum, file) => sum + file.size,
                    0,
                );
            },

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.processFiles(files);
            },

            handleDrop(e) {
                this.isDragging = false;
                const files = Array.from(e.dataTransfer.files).filter((file) =>
                    file.type.startsWith("image/"),
                );
                this.processFiles(files);
            },

            processFiles(files) {
                files.forEach((file) => {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(
                            `File ${file.name} is too large. Maximum size is 10MB.`,
                        );
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            this.selectedFiles.push({
                                file: file,
                                name: file.name,
                                size: file.size,
                                preview: e.target.result,
                                metadata: {
                                    width: img.width,
                                    height: img.height,
                                    aspectRatio: (
                                        img.width / img.height
                                    ).toFixed(2),
                                },
                                formData: {
                                    title: file.name.replace(/\.[^/.]+$/, ""),
                                    slug: this.generateSlug(
                                        file.name.replace(/\.[^/.]+$/, ""),
                                    ),
                                    description: "",
                                    altText: file.name.replace(/\.[^/.]+$/, ""),
                                    isPublic: "true",
                                },
                            });

                            if (this.selectedFiles.length === 1) {
                                this.loadCurrentFormData();
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                if (this.currentImageIndex >= this.selectedFiles.length) {
                    this.currentImageIndex = Math.max(
                        0,
                        this.selectedFiles.length - 1,
                    );
                }
                if (this.selectedFiles.length > 0) {
                    this.loadCurrentFormData();
                }
            },

            clearFiles() {
                this.selectedFiles = [];
                this.currentImageIndex = 0;
                this.step = 1;
            },

            loadCurrentFormData() {
                if (this.currentFile) {
                    this.currentFormData = { ...this.currentFile.formData };
                }
            },

            saveCurrentFormData() {
                if (this.currentFile) {
                    this.currentFile.formData = { ...this.currentFormData };
                }
            },

            nextImage() {
                this.saveCurrentFormData();
                if (this.currentImageIndex < this.selectedFiles.length - 1) {
                    this.currentImageIndex++;
                    this.loadCurrentFormData();
                }
            },

            previousImage() {
                this.saveCurrentFormData();
                if (this.currentImageIndex > 0) {
                    this.currentImageIndex--;
                    this.loadCurrentFormData();
                }
            },

            saveCurrentAndProceed() {
                this.saveCurrentFormData();
                if (this.currentImageIndex < this.selectedFiles.length - 1) {
                    this.nextImage();
                } else {
                    this.step = 3;
                }
            },

            generateSlug(text) {
                return text
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
            },

            formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    Math.round((bytes / Math.pow(k, i)) * 100) / 100 +
                    " " +
                    sizes[i]
                );
            },

            addTag() {
                const tag = this.tagInput.trim().toLowerCase();
                if (tag && !this.globalMetadata.tags.includes(tag)) {
                    this.globalMetadata.tags.push(tag);
                }
                this.tagInput = "";
                this.tagSuggestions = [];
            },

            selectTag(tag) {
                if (!this.globalMetadata.tags.includes(tag)) {
                    this.globalMetadata.tags.push(tag);
                }
                this.tagInput = "";
                this.tagSuggestions = [];
            },

            removeTag(index) {
                this.globalMetadata.tags.splice(index, 1);
            },

            searchTags() {
                if (this.tagInput.length < 2) {
                    this.tagSuggestions = [];
                    return;
                }
                // Filter popular tags based on input
                this.tagSuggestions = this.popularTags
                    .filter((tag) => tag.includes(this.tagInput.toLowerCase()))
                    .filter((tag) => !this.globalMetadata.tags.includes(tag))
                    .slice(0, 5);
            },

            async handleSubmit() {
                this.uploading = true;
                this.uploadProgress = 0;
                this.uploadStatus = "Preparing upload...";

                try {
                    const totalFiles = this.selectedFiles.length;

                    for (let i = 0; i < totalFiles; i++) {
                        const fileData = this.selectedFiles[i];
                        this.uploadStatus = `Uploading ${fileData.name} (${i + 1} of ${totalFiles})...`;

                        const formData = new FormData();
                        formData.append("file", fileData.file);
                        formData.append("title", fileData.formData.title);
                        formData.append("slug", fileData.formData.slug);
                        formData.append(
                            "description",
                            fileData.formData.description,
                        );
                        formData.append("alt_text", fileData.formData.altText);
                        formData.append(
                            "is_public",
                            fileData.formData.isPublic,
                        );

                        // Add global metadata
                        if (this.globalMetadata.category)
                            formData.append(
                                "category",
                                this.globalMetadata.category,
                            );
                        if (this.globalMetadata.subcategory)
                            formData.append(
                                "subcategory",
                                this.globalMetadata.subcategory,
                            );
                        if (this.globalMetadata.collection)
                            formData.append(
                                "collection",
                                this.globalMetadata.collection,
                            );
                        if (this.globalMetadata.series)
                            formData.append(
                                "series",
                                this.globalMetadata.series,
                            );
                        if (this.globalMetadata.copyrightHolder)
                            formData.append(
                                "copyright_holder",
                                this.globalMetadata.copyrightHolder,
                            );
                        if (this.globalMetadata.license)
                            formData.append(
                                "license",
                                this.globalMetadata.license,
                            );
                        formData.append(
                            "allow_download",
                            this.globalMetadata.allowDownload,
                        );
                        formData.append(
                            "mature_content",
                            this.globalMetadata.matureContent,
                        );
                        formData.append(
                            "featured",
                            this.globalMetadata.featured,
                        );

                        // Add tags
                        this.globalMetadata.tags.forEach((tag) => {
                            formData.append("tags[]", tag);
                        });

                        const response = await fetch("/api/images/upload", {
                            method: "POST",
                            body: formData,
                        });

                        if (!response.ok) {
                            throw new Error(
                                `Upload failed for ${fileData.name}`,
                            );
                        }

                        this.uploadProgress = Math.round(
                            ((i + 1) / totalFiles) * 100,
                        );
                    }

                    this.uploadStatus = "Upload complete! Redirecting...";
                    setTimeout(() => {
                        window.location.href = "/images";
                    }, 1500);
                } catch (error) {
                    console.error("Upload error:", error);
                    alert("Upload failed: " + error.message);
                    this.uploading = false;
                }
            },

            init() {
                // Watch for title changes to auto-generate slug
                this.$watch("currentFormData.title", (value) => {
                    if (value) {
                        this.currentFormData.slug = this.generateSlug(value);
                    }
                });
            },
        };
    }
</script>
{% endblock %}
