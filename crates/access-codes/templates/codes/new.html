{% extends "base-tailwind.html" %} {% block title %}Create Access Code{% endblock %} {%
block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
            <a href="/access/codes" class="btn btn-ghost btn-sm gap-1">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"
                    />
                </svg>
                Back to Access Codes
            </a>
        </div>
        <h1 class="text-4xl font-bold mb-2">üîë Create Access Code</h1>
        <p class="text-base-content/70">
            Share resources with others using a simple access code
        </p>
    </div>

    <!-- Progress Indicators -->
    <ul class="steps steps-vertical lg:steps-horizontal w-full mb-8">
        <li class="step step-primary" data-step="1">Basic Info</li>
        <li class="step" data-step="2">Access Type</li>
        <li class="step" data-step="3">Select Resources</li>
        <li class="step" data-step="4">Review & Create</li>
    </ul>

    <!-- Alert Messages -->
    <div id="errorAlert" class="alert alert-error mb-6 hidden">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="stroke-current shrink-0 h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
        </svg>
        <span id="errorMessage"></span>
    </div>

    <div id="successAlert" class="alert alert-success mb-6 hidden">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="stroke-current shrink-0 h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
        </svg>
        <span id="successMessage"></span>
    </div>

    <!-- Main Form -->
    <form id="createCodeForm" class="space-y-6">
        <!-- Step 1: Basic Information -->
        <div class="card bg-base-100 shadow-xl" data-step-content="1">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">1Ô∏è‚É£ Basic Information</h2>

                <!-- Code Name -->
                <div class="form-control">
                    <div class="flex items-baseline justify-between mb-1">
                        <span class="label-text font-semibold"
                            >Code Name *</span
                        >
                        <span class="label-text-alt text-base-content/60"
                            >Required</span
                        >
                    </div>
                    <input
                        type="text"
                        id="codeName"
                        name="code"
                        placeholder="e.g., website-2024, course-preview, client-demo"
                        class="input input-bordered w-full"
                        required
                        maxlength="50"
                        pattern="[a-zA-Z0-9_-]+"
                    />
                    <div class="flex items-start justify-between mt-1">
                        <span class="label-text-alt text-base-content/60">
                            Letters, numbers, hyphens, and underscores only. Max
                            50 characters.
                        </span>
                        <span class="label-text-alt whitespace-nowrap ml-2" id="codeNameCount"
                            >0/50</span
                        >
                    </div>
                </div>

                <!-- Description -->
                <div class="form-control">
                    <div class="flex items-baseline justify-between mb-1">
                        <span class="label-text font-semibold"
                            >Description</span
                        >
                        <span class="label-text-alt text-base-content/60"
                            >Optional</span
                        >
                    </div>
                    <textarea
                        id="description"
                        name="description"
                        placeholder="Brief description of what this access code is for..."
                        class="textarea textarea-bordered h-24"
                        maxlength="500"
                    ></textarea>
                    <div class="flex items-start justify-between mt-1">
                        <span class="label-text-alt text-base-content/60"
                            >Help you remember the purpose of this code.</span
                        >
                        <span class="label-text-alt whitespace-nowrap ml-2" id="descriptionCount"
                            >0/500</span
                        >
                    </div>
                </div>

                <!-- Expiration -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Expiration</span>
                    </label>
                    <div class="flex flex-col md:flex-row gap-4">
                        <label class="cursor-pointer flex items-center gap-2">
                            <input
                                type="radio"
                                name="expirationType"
                                value="never"
                                class="radio radio-primary"
                                checked
                            />
                            <span class="label-text">Never expires</span>
                        </label>
                        <label class="cursor-pointer flex items-center gap-2">
                            <input
                                type="radio"
                                name="expirationType"
                                value="date"
                                class="radio radio-primary"
                            />
                            <span class="label-text">Set expiration date</span>
                        </label>
                    </div>
                </div>

                <!-- Expiration Date (conditional) -->
                <div id="expirationDateSection" class="form-control hidden">
                    <label class="label">
                        <span class="label-text font-semibold"
                            >Expiration Date & Time</span
                        >
                    </label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input
                            type="date"
                            id="expirationDate"
                            name="expirationDate"
                            class="input input-bordered flex-1"
                        />
                        <input
                            type="time"
                            id="expirationTime"
                            name="expirationTime"
                            value="23:59"
                            class="input input-bordered sm:w-32 w-full"
                        />
                    </div>
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">
                            After this date, the access code will no longer
                            work.
                        </span>
                    </label>
                </div>

                <div class="card-actions justify-end mt-4">
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="goToStep(2)"
                    >
                        Next: Access Type
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Access Type -->
        <div class="card bg-base-100 shadow-xl hidden" data-step-content="2">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">2Ô∏è‚É£ Access Type</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Individual Resources -->
                    <label
                        class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors"
                    >
                        <div class="card-body">
                            <div class="flex items-start gap-3">
                                <input
                                    type="radio"
                                    name="accessType"
                                    value="individual"
                                    class="radio radio-primary mt-1"
                                    checked
                                />
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg mb-2">
                                        üìã Individual Resources
                                    </h3>
                                    <p
                                        class="text-sm text-base-content/70 mb-3"
                                    >
                                        Hand-pick specific videos and images to
                                        share.
                                    </p>
                                    <div class="text-xs space-y-1">
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3 text-success"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            <span
                                                >Select 1-10 specific
                                                resources</span
                                            >
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3 text-success"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            <span
                                                >Perfect for one-off
                                                shares</span
                                            >
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3 text-success"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            <span
                                                >Resources from different
                                                groups</span
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Group Access (Future) -->
                    <label
                        class="card bg-base-200 cursor-not-allowed opacity-60"
                    >
                        <div class="card-body">
                            <div class="flex items-start gap-3">
                                <input
                                    type="radio"
                                    name="accessType"
                                    value="group"
                                    class="radio radio-primary mt-1"
                                    disabled
                                />
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg mb-2">
                                        üìö Group Access
                                        <span class="badge badge-sm"
                                            >Soon‚Ñ¢</span
                                        >
                                    </h3>
                                    <p
                                        class="text-sm text-base-content/70 mb-3"
                                    >
                                        Share all resources in a group with one
                                        code.
                                    </p>
                                    <div class="text-xs space-y-1">
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                            <span
                                                >All current & future
                                                resources</span
                                            >
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                            <span
                                                >Perfect for courses &
                                                projects</span
                                            >
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-3 w-3"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                            <span>Content added over time</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>

                <div class="card-actions justify-between mt-4">
                    <button
                        type="button"
                        class="btn btn-ghost"
                        onclick="goToStep(1)"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 19l-7-7 7-7"
                            />
                        </svg>
                        Back
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="goToStep(3)"
                    >
                        Next: Select Resources
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Select Resources -->
        <div class="card bg-base-100 shadow-xl hidden" data-step-content="3">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">3Ô∏è‚É£ Select Resources</h2>

                <!-- Search and Filter -->
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <input
                            type="text"
                            id="resourceSearch"
                            placeholder="Search your resources..."
                            class="input input-bordered w-full"
                        />
                    </div>
                    <select
                        id="resourceTypeFilter"
                        class="select select-bordered w-full md:w-48"
                    >
                        <option value="all">All Types</option>
                        <option value="video">Videos Only</option>
                        <option value="image">Images Only</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div
                    id="resourcesLoading"
                    class="flex justify-center items-center py-12"
                >
                    <span class="loading loading-spinner loading-lg"></span>
                </div>

                <!-- Resources List -->
                <div id="resourcesList" class="hidden">
                    <div class="alert alert-info mb-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <span
                            >Select the resources you want to share with this
                            access code. You can only share resources you
                            own.</span
                        >
                    </div>

                    <div class="mb-4 text-sm text-base-content/70">
                        <span id="selectedCount">0</span> resources selected
                    </div>

                    <!-- Resources Grid -->
                    <div
                        id="resourcesGrid"
                        class="grid grid-cols-1 gap-3 max-h-96 overflow-y-auto"
                    >
                        <!-- Resources will be loaded here via JavaScript -->
                    </div>
                </div>

                <!-- Empty State -->
                <div id="noResources" class="hidden text-center py-12">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-24 w-24 mx-auto text-base-content/30 mb-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="1"
                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                        />
                    </svg>
                    <h3 class="text-xl font-bold mb-2">No Resources Found</h3>
                    <p class="text-base-content/70">
                        Upload some videos or images first to share them with
                        access codes.
                    </p>
                </div>

                <div class="card-actions justify-between mt-4">
                    <button
                        type="button"
                        class="btn btn-ghost"
                        onclick="goToStep(2)"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 19l-7-7 7-7"
                            />
                        </svg>
                        Back
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="goToStep(4)"
                        id="nextToReview"
                        disabled
                    >
                        Next: Review & Create
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Review & Create -->
        <div class="card bg-base-100 shadow-xl hidden" data-step-content="4">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">4Ô∏è‚É£ Review & Create</h2>

                <div class="space-y-4">
                    <!-- Code Details -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="font-bold text-lg mb-3">
                                Access Code Details
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex flex-wrap justify-between gap-2">
                                    <span class="text-base-content/70"
                                        >Code Name:</span
                                    >
                                    <span
                                        class="font-semibold text-right"
                                        id="reviewCodeName"
                                    ></span>
                                </div>
                                <div class="flex flex-wrap justify-between gap-2">
                                    <span class="text-base-content/70"
                                        >Description:</span
                                    >
                                    <span
                                        class="font-semibold text-right"
                                        id="reviewDescription"
                                        >None</span
                                    >
                                </div>
                                <div class="flex flex-wrap justify-between gap-2">
                                    <span class="text-base-content/70"
                                        >Expiration:</span
                                    >
                                    <span
                                        class="font-semibold text-right"
                                        id="reviewExpiration"
                                        >Never</span
                                    >
                                </div>
                                <div class="flex flex-wrap justify-between gap-2">
                                    <span class="text-base-content/70"
                                        >Access Type:</span
                                    >
                                    <span class="font-semibold text-right"
                                        >Individual Resources</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Resources -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="font-bold text-lg mb-3">
                                Selected Resources (<span
                                    id="reviewResourceCount"
                                    >0</span
                                >)
                            </h3>
                            <div
                                id="reviewResourcesList"
                                class="space-y-2 max-h-64 overflow-y-auto"
                            >
                                <!-- Resources will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Generated URL Preview -->
                    <div class="card bg-primary/10 border-2 border-primary">
                        <div class="card-body">
                            <h3 class="font-bold text-lg mb-3">
                                üîó Generated URLs
                            </h3>
                            <p class="text-sm text-base-content/70 mb-3">
                                Share these URLs to grant access to your
                                selected resources:
                            </p>
                            <div id="previewUrls" class="space-y-2">
                                <!-- URLs will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-actions justify-between mt-6">
                    <button
                        type="button"
                        class="btn btn-ghost"
                        onclick="goToStep(3)"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 19l-7-7 7-7"
                            />
                        </svg>
                        Back
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary btn-lg gap-2"
                        id="createButton"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"
                            />
                        </svg>
                        Create Access Code
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // State
    let currentStep = 1;
    let selectedResources = [];
    let allResources = [];

    // Character counters
    document.getElementById("codeName").addEventListener("input", (e) => {
        document.getElementById("codeNameCount").textContent =
            `${e.target.value.length}/50`;
    });

    document.getElementById("description").addEventListener("input", (e) => {
        document.getElementById("descriptionCount").textContent =
            `${e.target.value.length}/500`;
    });

    // Expiration type toggle
    document
        .querySelectorAll('input[name="expirationType"]')
        .forEach((radio) => {
            radio.addEventListener("change", (e) => {
                const dateSection = document.getElementById(
                    "expirationDateSection",
                );
                if (e.target.value === "date") {
                    dateSection.classList.remove("hidden");
                    // Set default to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById("expirationDate").value = tomorrow
                        .toISOString()
                        .split("T")[0];
                } else {
                    dateSection.classList.add("hidden");
                }
            });
        });

    // Step navigation
    function goToStep(step) {
        // Validate current step before proceeding
        if (step > currentStep && !validateStep(currentStep)) {
            return;
        }

        // Hide all steps
        document.querySelectorAll("[data-step-content]").forEach((el) => {
            el.classList.add("hidden");
        });

        // Show current step
        document
            .querySelector(`[data-step-content="${step}"]`)
            .classList.remove("hidden");

        // Update progress indicators
        document.querySelectorAll(".step").forEach((el) => {
            const stepNum = parseInt(el.dataset.step);
            if (stepNum <= step) {
                el.classList.add("step-primary");
            } else {
                el.classList.remove("step-primary");
            }
        });

        currentStep = step;

        // Load resources when reaching step 3
        if (step === 3 && allResources.length === 0) {
            loadResources();
        }

        // Update review when reaching step 4
        if (step === 4) {
            updateReview();
        }

        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function validateStep(step) {
        if (step === 1) {
            const codeName = document.getElementById("codeName").value.trim();
            if (!codeName) {
                showError("Please enter a code name");
                return false;
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(codeName)) {
                showError(
                    "Code name can only contain letters, numbers, hyphens, and underscores",
                );
                return false;
            }
        }
        return true;
    }

    // Load user's resources
    async function loadResources() {
        try {
            document
                .getElementById("resourcesLoading")
                .classList.remove("hidden");
            document.getElementById("resourcesList").classList.add("hidden");

            // Fetch videos
            const videosResponse = await fetch("/api/videos");
            const videos = videosResponse.ok ? await videosResponse.json() : [];

            // Fetch images
            const imagesResponse = await fetch("/api/images");
            const images = imagesResponse.ok ? await imagesResponse.json() : [];

            allResources = [
                ...videos.map((v) => ({
                    type: "video",
                    slug: v.slug,
                    title: v.title || v.slug,
                })),
                ...images.map((i) => ({
                    type: "image",
                    slug: i.slug,
                    title: i.title || i.slug,
                })),
            ];

            if (allResources.length === 0) {
                document
                    .getElementById("resourcesLoading")
                    .classList.add("hidden");
                document
                    .getElementById("noResources")
                    .classList.remove("hidden");
            } else {
                document
                    .getElementById("resourcesLoading")
                    .classList.add("hidden");
                document
                    .getElementById("resourcesList")
                    .classList.remove("hidden");
                renderResources();
            }
        } catch (error) {
            console.error("Error loading resources:", error);
            showError("Failed to load resources");
        }
    }

    function renderResources() {
        const container = document.getElementById("resourcesGrid");
        const searchTerm = document
            .getElementById("resourceSearch")
            .value.toLowerCase();
        const typeFilter = document.getElementById("resourceTypeFilter").value;

        const filtered = allResources.filter((r) => {
            const matchesSearch =
                r.title.toLowerCase().includes(searchTerm) ||
                r.slug.toLowerCase().includes(searchTerm);
            const matchesType = typeFilter === "all" || r.type === typeFilter;
            return matchesSearch && matchesType;
        });

        container.innerHTML = filtered
            .map((resource) => {
                const isSelected = selectedResources.some(
                    (r) => r.type === resource.type && r.slug === resource.slug,
                );
                const icon = resource.type === "video" ? "üé•" : "üñºÔ∏è";

                return `
                <label class="flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer hover:bg-base-200 transition-colors ${isSelected ? "border-primary bg-primary/10" : "border-base-300"}">
                    <input
                        type="checkbox"
                        class="checkbox checkbox-primary"
                        ${isSelected ? "checked" : ""}
                        onchange="toggleResource('${resource.type}', '${resource.slug}', '${resource.title.replace(/'/g, "\\'")}')"
                    />
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold flex items-center gap-2">
                            <span>${icon}</span>
                            <span class="truncate">${resource.title}</span>
                        </div>
                        <div class="text-xs text-base-content/60 truncate">${resource.slug}</div>
                    </div>
                    <span class="badge badge-sm">${resource.type}</span>
                </label>
            `;
            })
            .join("");

        if (filtered.length === 0) {
            container.innerHTML =
                '<div class="text-center py-8 text-base-content/60">No resources match your search</div>';
        }
    }

    function toggleResource(type, slug, title) {
        const index = selectedResources.findIndex(
            (r) => r.type === type && r.slug === slug,
        );
        if (index > -1) {
            selectedResources.splice(index, 1);
        } else {
            selectedResources.push({ type, slug, title });
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = selectedResources.length;
        document.getElementById("selectedCount").textContent = count;
        document.getElementById("nextToReview").disabled = count === 0;
    }

    // Search and filter
    document
        .getElementById("resourceSearch")
        .addEventListener("input", renderResources);
    document
        .getElementById("resourceTypeFilter")
        .addEventListener("change", renderResources);

    // Update review step
    function updateReview() {
        const codeName = document.getElementById("codeName").value;
        const description = document.getElementById("description").value.trim();
        const expirationType = document.querySelector(
            'input[name="expirationType"]:checked',
        ).value;

        document.getElementById("reviewCodeName").textContent = codeName;
        document.getElementById("reviewDescription").textContent =
            description || "None";

        if (expirationType === "date") {
            const date = document.getElementById("expirationDate").value;
            const time = document.getElementById("expirationTime").value;
            document.getElementById("reviewExpiration").textContent =
                `${date} at ${time}`;
        } else {
            document.getElementById("reviewExpiration").textContent = "Never";
        }

        // Resources list
        document.getElementById("reviewResourceCount").textContent =
            selectedResources.length;
        const resourcesList = document.getElementById("reviewResourcesList");
        resourcesList.innerHTML = selectedResources
            .map((r) => {
                const icon = r.type === "video" ? "üé•" : "üñºÔ∏è";
                return `
                <div class="flex items-center gap-2 text-sm">
                    <span>${icon}</span>
                    <span class="font-semibold">${r.title}</span>
                    <span class="text-base-content/60">(${r.slug})</span>
                </div>
            `;
            })
            .join("");

        // Generate preview URLs
        const baseUrl = window.location.origin;
        const previewUrls = document.getElementById("previewUrls");
        previewUrls.innerHTML =
            selectedResources
                .slice(0, 3)
                .map((r) => {
                    const url = `${baseUrl}/access/preview?code=${codeName}`;
                    return `
                <div class="flex gap-2 items-center">
                    <input
                        type="text"
                        value="${url}"
                        readonly
                        class="input input-sm input-bordered flex-1 text-xs"
                    />
                    <button
                        type="button"
                        onclick="copyToClipboard('${url}')"
                        class="btn btn-sm btn-square"
                        title="Copy URL"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
            `;
                })
                .join("") +
            (selectedResources.length > 3
                ? `
            <div class="text-xs text-base-content/60 mt-2">
                ... and ${selectedResources.length - 3} more resources
            </div>
        `
                : "");

        if (selectedResources.length > 3) {
            previewUrls.innerHTML += `<div class="text-xs text-base-content/60">+ ${selectedResources.length - 3} more resources...</div>`;
        }
    }

    // Form submission
    document
        .getElementById("createCodeForm")
        .addEventListener("submit", async (e) => {
            e.preventDefault();

            const codeName = document.getElementById("codeName").value.trim();
            const description = document
                .getElementById("description")
                .value.trim();
            const expirationType = document.querySelector(
                'input[name="expirationType"]:checked',
            ).value;

            let expiresAt = null;
            if (expirationType === "date") {
                const date = document.getElementById("expirationDate").value;
                const time = document.getElementById("expirationTime").value;
                expiresAt = `${date}T${time}:00Z`;
            }

            const requestBody = {
                code: codeName,
                description: description || null,
                expires_at: expiresAt,
                media_items: selectedResources.map((r) => ({
                    media_type: r.type,
                    media_slug: r.slug,
                })),
            };

            const createButton = document.getElementById("createButton");
            createButton.disabled = true;
            createButton.innerHTML =
                '<span class="loading loading-spinner"></span> Creating...';

            try {
                const response = await fetch("/api/access-codes", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestBody),
                });

                if (response.ok) {
                    showSuccess("Access code created successfully!");
                    setTimeout(() => {
                        window.location.href = "/access/codes";
                    }, 1500);
                } else if (response.status === 409) {
                    showError(
                        "This code name is already taken. Please choose a different name.",
                    );
                    createButton.disabled = false;
                    createButton.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg> Create Access Code';
                } else {
                    const error = await response.text();
                    showError(`Failed to create access code: ${error}`);
                    createButton.disabled = false;
                    createButton.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg> Create Access Code';
                }
            } catch (error) {
                console.error("Error creating access code:", error);
                showError("Network error. Please try again.");
                createButton.disabled = false;
                createButton.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg> Create Access Code';
            }
        });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showSuccess("URL copied to clipboard!");
        });
    }

    function showError(message) {
        const alert = document.getElementById("errorAlert");
        const messageEl = document.getElementById("errorMessage");
        messageEl.textContent = message;
        alert.classList.remove("hidden");
        setTimeout(() => alert.classList.add("hidden"), 5000);
    }

    function showSuccess(message) {
        const alert = document.getElementById("successAlert");
        const messageEl = document.getElementById("successMessage");
        messageEl.textContent = message;
        alert.classList.remove("hidden");
        setTimeout(() => alert.classList.add("hidden"), 3000);
    }
</script>
{% endblock %}
