{% extends "base-tailwind.html" %}
{% block title %}{{ video.title }} - Video Server{% endblock %}

{% block extra_head %}
<style>
    .video-player-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        background: #000;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .video-player-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .related-video-card {
        transition: all 0.3s ease;
    }
    .related-video-card:hover {
        transform: translateY(-2px);
    }
    .share-modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }
    .stat-card {
        transition: all 0.2s;
    }
    .stat-card:hover {
        transform: scale(1.05);
    }
    .tag-link {
        transition: all 0.2s;
    }
    .tag-link:hover {
        transform: translateY(-1px);
    }
    .description-text {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl" x-data="videoDetail()">
    <!-- Breadcrumb Navigation -->
    <div class="text-sm breadcrumbs mb-4">
        <ul></ul>
            <li><a href="/">Home</a></li>
            <li><a href="/videos">Videos</a></li>
            <li>{{ video.title }}</li>
        </ul>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (Left - 2 columns) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Video Player -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body p-0">
                    <div class="video-player-container">
                        <video
                            id="videoPlayer"
                            controls
                            preload="metadata"
                            @play="handlePlay"
                            @ended="handleEnded"
                            class="w-full h-full"
                        >
                            <source src="/storage/videos/{{ video.is_public ? 'public' : 'private' }}/{{ video.slug }}/video.mp4" type="video/mp4">
                            <source src="/storage/videos/{{ video.is_public ? 'public' : 'private' }}/{{ video.slug }}/video.webm" type="video/webm">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Video Info -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <!-- Title and Actions -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4">
                        <div class="flex-1">
                            <h1 class="text-3xl font-bold text-base-content mb-2">{{ video.title }}</h1>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-base-content/60">
                                <span class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    <span x-text="viewCount + ' views'">{{ video.view_count }} views</span>
                                </span>
                                <span>‚Ä¢</span>
                                <span></span>{{ video.upload_date | default(value="Unknown date") }}</span>
                                <span>‚Ä¢</span>
                                <span class="badge" :class="video.isPublic ? 'badge-success' : 'badge-error'">
                                    {{ video.is_public ? 'PUBLIC' : 'PRIVATE' }}
                                </span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2">
                            <button @click="toggleLike" class="btn btn-outline gap-2" :class="{ 'btn-primary': liked }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :fill="liked ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                                <span x-text="likeCount">{{ video.like_count }}</span>
                            </button>

                            <button @click="showShareModal = true" class="btn btn-outline gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                                Share
                            </button>

                            {% if authenticated %}
                            <a href="/videos/{{ video.id }}/edit" class="btn btn-outline gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Edit
                            </a>

                            <button @click="confirmDelete" class="btn btn-error btn-outline gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Tags -->
                    <div x-show="tags.length > 0" class="mb-4">
                        <h3 class="font-bold mb-2">Tags</h3>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in tags" :key="tag">
                                <a
                                    :href="'/videos?tag=' + tag"
                                    class="badge badge-primary badge-lg gap-2 tag-link"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                    </svg>
                                    <span x-text="tag"></span>
                                </a>
                            </template>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Description</h3>
                        <div
                            class="description-text text-base-content/80"
                            :class="{ 'line-clamp-3': !showFullDescription }"
                        >
                            {{ video.description | default(value="No description available.") }}
                        </div>
                        <button
                            x-show="hasLongDescription"
                            @click="showFullDescription = !showFullDescription"
                            class="btn btn-ghost btn-sm mt-2"
                        >
                            <span x-text="showFullDescription ? 'Show Less' : 'Show More'"></span>
                        </button>
                    </div>

                    <!-- Video Details -->
                    <div class="collapse collapse-arrow bg-base-200">
                        <input type="checkbox">
                        <div class="collapse-title font-bold">
                            üìä Video Details
                        </div>
                        <div class="collapse-content">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                <div>
                                    <span class="font-semibold">Duration:</span>
                                    <span class="ml-2" x-text="formatDuration({{ video.duration | default(value=0) }})"></span>
                                </div>
                                <div>
                                    <span class="font-semibold">Resolution:</span>
                                    <span class="ml-2">{{ video.resolution | default(value="N/A") }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">File Size:</span>
                                    <span class="ml-2" x-text="formatFileSize({{ video.file_size | default(value=0) }})"></span>
                                </div>
                                <div>
                                    <span class="font-semibold">Format:</span>
                                    <span class="ml-2">{{ video.format | default(value="MP4") }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Category:</span>
                                    <span class="ml-2">{{ video.category | default(value="Uncategorized") }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Language:</span>
                                    <span class="ml-2">{{ video.language | default(value="English") }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Status:</span>
                                    <span class="ml-2 capitalize">{{ video.status | default(value="active") }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Video ID:</span>
                                    <span class="ml-2 font-mono text-sm">{{ video.slug }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title mb-4">üìà Statistics</h3>
                    <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                        <div class="stat stat-card">
                            <div class="stat-figure text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </div>
                            <div class="stat-title">Total Views</div>
                            <div class="stat-value text-primary" x-text="viewCount">{{ video.view_count }}</div>
                            <div class="stat-desc">Since upload</div>
                        </div>

                        <div class="stat stat-card">
                            <div class="stat-figure text-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </div>
                            <div class="stat-title">Likes</div>
                            <div class="stat-value text-secondary" x-text="likeCount">{{ video.like_count }}</div>
                            <div class="stat-desc">‚ÜóÔ∏é Growing</div>
                        </div>

                        <div class="stat stat-card">
                            <div class="stat-figure text-accent">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                            </div>
                            <div class="stat-title">Shares</div>
                            <div class="stat-value text-accent" x-text="shareCount">{{ video.share_count | default(value=0) }}</div>
                            <div class="stat-desc">Via social media</div>
                        </div>

                        <div class="stat stat-card">
                            <div class="stat-figure text-info">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </div>
                            <div class="stat-title">Downloads</div>
                            <div class="stat-value text-info">{{ video.download_count | default(value=0) }}</div>
                            <div class="stat-desc">{{ video.allow_download ? "Enabled" : "Disabled" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comments Section (Placeholder) -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title mb-4">üí¨ Comments</h3>
                    <div class="text-center py-8 text-base-content/60">
                        <div class="text-4xl mb-2">üí≠</div>
                        <p>Comments</p> feature coming soon!</p>
                        <p class="text-sm mt-2">Be the first to share your thoughts about this video.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar (Right - 1 column) -->
        <div class="space-y-6">
            <!-- Related Videos -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title mb-4">üé¨ Related Videos</h3>

                    <div class="space-y-3" x-show="relatedVideos.length > 0">
                        <template x-for="video in relatedVideos" :key="video.id">
                            <a
                                :href="'/watch/' + video.slug"
                                class="flex gap-3 p-2 rounded-lg hover:bg-base-200 related-video-card"
                            >
                                <div class="w-40 h-24 bg-base-300 rounded overflow-hidden flex-shrink-0">
                                    <img
                                        :src="video.thumbnail_url || '/storage/placeholder.jpg'"
                                        :alt="video.title"
                                        class="w-full h-full object-cover"
                                        onerror="this.src='/storage/placeholder.jpg'"
                                    >
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-sm line-clamp-2 mb-1" x-text="video.title"></h4>
                                    <p class="text-xs text-base-content/60 line-clamp-2" x-text="video.short_description"></p>
                                    <div class="flex items-center gap-2 mt-2 text-xs text-base-content/50">
                                        <span x-text="video.view_count + ' views'"></span>
                                        <span>‚Ä¢</span>
                                        <span x-text="formatDuration(video.duration)"></span>
                                    </div>
                                </div>
                            </a>
                        </template>
                    </div>

                    <div x-show="relatedVideos.length === 0" class="text-center py-8 text-base-content/60">
                        <div class="text-3xl mb-2">üîç</div>
                        <p class="text-sm">No related videos found</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title mb-4">‚ö° Quick Actions</h3>
                    <div class="space-y-2">
                        <a href="/videos" class="btn btn-outline btn-block btn-sm gap-2 justify-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                            </svg>
                            All Videos
                        </a>

                        {% if authenticated %}
                        <a href="/videos/upload" class="btn btn-primary btn-block btn-sm gap-2 justify-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            Upload New Video
                        </a>
                        {% endif %}

                        <button @click="downloadVideo" class="btn btn-outline btn-block btn-sm gap-2 justify-start" :disabled="!allowDownload">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            <span x-text="allowDownload ? 'Download Video' : 'Download Disabled'"></span>
                        </button>

                        <button @click="reportVideo" class="btn btn-outline btn-block btn-sm gap-2 justify-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd" />
                            </svg>
                            Report Video
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div x-show="showShareModal" class="modal modal-open" x-cloak>
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-2xl mb-6">Share This Video</h3>

            <!-- Share URL -->
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-semibold">Video URL</span>
                </label>
                <div class="flex gap-2">
                    <input
                        type="text"
                        :value="shareUrl"
                        readonly
                        class="input input-bordered flex-1"
                        @click="$event.target.select()"
                    >
                    <button @click="copyToClipboard(shareUrl)" class="btn btn-primary">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Embed Code -->
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-semibold">Embed Code (iframe)</span>
                </label>
                <div class="flex gap-2">
                    <textarea
                        :value="embedCode"
                        readonly
                        class="textarea textarea-bordered flex-1 font-mono text-xs"
                        rows="3"
                        @click="$event.target.select()"
                    ></textarea>
                    <button @click="copyToClipboard(embedCode)" class="btn btn-primary">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Social Share Buttons -->
            <div class="mb-4">
                <label class="label">
                    <span class="label-text font-semibold">Share on Social Media</span>
                </label>
                <div class="flex flex-wrap gap-2">
                    <button @click="shareOnTwitter" class="btn btn-sm gap-2">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Twitter
                    </button>
                    <button @click="shareOnFacebook" class="btn btn-sm gap-2">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>
                    <button @click="shareOnLinkedIn" class="btn btn-sm gap-2">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </button>
                    <button @click="shareOnReddit" class="btn btn-sm gap-2">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                        </svg>
                        Reddit
                    </button>
                    <button @click="shareViaEmail" class="btn btn-sm gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Email
                    </button>
                </div>
            </div>

            <div class="modal-action">
                <button @click="showShareModal = false" class="btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" class="modal modal-open" x-cloak>
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">‚ö†Ô∏è Confirm Deletion</h3>
            <p class="py-4">
                Are you sure you want to delete this video? This action cannot be undone.
            </p>
            <p class="text-error font-bold mb-4">
                Video: {{ video.title }}
            </p>
            <div class="modal-action">
                <button @click="showDeleteModal = false" class="btn btn-ghost">Cancel</button>
                <button @click="deleteVideo" class="btn btn-error gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function videoDetail() {
    return {
        // Video data
        video: {
            id: {{ video.id }},
            slug: '{{ video.slug }}',
            title: '{{ video.title }}',
            isPublic: {{ video.is_public | default(value=0) }} === 1,
        },

        // State
        viewCount: {{ video.view_count | default(value=0) }},
        likeCount: {{ video.like_count | default(value=0) }},
        shareCount: {{ video.share_count | default(value=0) }},
        liked: false,
        allowDownload: {{ video.allow_download | default(value=0) }} === 1,
        showFullDescription: false,
        hasLongDescription: '{{ video.description | default(value="") }}'.length > 200,

        // Tags (will be loaded from API)
        tags: [],

        // Related videos (will be loaded from API)
        relatedVideos: [],

        // Modals
        showShareModal: false,
        showDeleteModal: false,

        // Share URLs
        shareUrl: window.location.href,
        embedCode: '',

        async init() {
            // Generate embed code
            this.embedCode = `<iframe width="560" height="315" src="${window.location.origin}/embed/${this.video.slug}" frameborder="0" allowfullscreen></iframe>`;

            // Load tags
            await this.loadTags();

            // Load related videos
            await this.loadRelatedVideos();

            // Increment view count
            await this.incrementViewCount();
        },

        async loadTags() {
            try {
                const response = await fetch(`/api/videos/${this.video.id}/tags`);
                if (response.ok) {
                    const data = await response.json();
                    this.tags = data.tags || [];
                }
            } catch (error) {
                console.error('Failed to load tags:', error);
            }
        },

        async loadRelatedVideos() {
            try {
                const response = await fetch(`/api/videos/${this.video.id}/related?limit=6`);
                if (response.ok) {
                    const data = await response.json();
                    this.relatedVideos = data.videos || [];
                }
            } catch (error) {
                console.error('Failed to load related videos:', error);
                // Mock data for demo
                this.relatedVideos = [
                    { id: 1, slug: 'video-1', title: 'Related Video 1', short_description: 'Description 1', view_count: 100, duration: 300, thumbnail_url: '' },
                    { id: 2, slug: 'video-2', title: 'Related Video 2', short_description: 'Description 2', view_count: 200, duration: 600, thumbnail_url: '' },
                ];
            }
        },

        async incrementViewCount() {
            try {
                const response = await fetch(`/api/videos/${this.video.id}/view`, {
                    method: 'POST'
                });
                if (response.ok) {
                    this.viewCount++;
                }
            } catch (error) {
                console.error('Failed to increment view count:', error);
            }
        },

        handlePlay() {
            console.log('Video started playing');
        },

        handleEnded() {
            console.log('Video playback ended');
        },

        async toggleLike() {
            try {
                const response = await fetch(`/api/videos/${this.video.id}/like`, {
                    method: 'POST'
                });
                if (response.ok) {
                    this.liked = !this.liked;
                    this.likeCount += this.liked ? 1 : -1;
                    showToast(this.liked ? 'Added to liked videos' : 'Removed from liked videos', 'success');
                }
            } catch (error) {
                console.error('Failed to toggle like:', error);
                showToast('Failed to update like status', 'error');
            }
        },

        copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        },

        shareOnTwitter() {
            const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(this.shareUrl)}&text=${encodeURIComponent(this.video.title)}`;
            window.open(url, '_blank', 'width=600,height=400');
            this.shareCount++;
        },

        shareOnFacebook() {
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(this.shareUrl)}`;
            window.open(url, '_blank', 'width=600,height=400');
            this.shareCount++;
        },

        shareOnLinkedIn() {
            const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(this.shareUrl)}`;
            window.open(url, '_blank', 'width=600,height=400');
            this.shareCount++;
        },

        shareOnReddit() {
            const url = `https://reddit.com/submit?url=${encodeURIComponent(this.shareUrl)}&title=${encodeURIComponent(this.video.title)}`;
            window.open(url, '_blank', 'width=600,height=400');
            this.shareCount++;
        },

        shareViaEmail() {
            const subject = encodeURIComponent(`Check out: ${this.video.title}`);
            const body = encodeURIComponent(`I thought you might like this video:\n\n${this.shareUrl}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        },

        downloadVideo() {
            if (!this.allowDownload) {
                showToast('Downloads are not enabled for this video', 'warning');
                return;
            }

            const link = document.createElement('a');
            link.href = `/api/videos/${this.video.id}/download`;
            link.download = `${this.video.slug}.mp4`;
            link.click();
            showToast('Download started', 'success');
        },

        reportVideo() {
            showToast('Report feature coming soon', 'info');
        },

        confirmDelete() {
            this.showDeleteModal = true;
        },

        async deleteVideo() {
            try {
                const response = await fetch(`/api/videos/${this.video.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Video deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = '/videos';
                    }, 1500);
                } else {
                    throw new Error('Failed to delete video');
                }
            } catch (error) {
                showToast('Failed to delete video: ' + error.message, 'error');
                this.showDeleteModal = false;
            }
        },

        formatDuration(seconds) {
            if (!seconds) return '0:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return h > 0
                ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
                : `${m}:${s.toString().padStart(2, '0')}`;
        },

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    }
}
</script>
{% endblock %}
