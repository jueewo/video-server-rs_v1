{% extends "base.html" %} {% block title %}Access Code: {{ code.code }}{%
endblock %} {% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- Breadcrumb -->
    <div class="mb-8">
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="/access/codes">Access Codes</a></li>
                <li>{{ code.code }}</li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <div
        class="flex flex-col md:flex-row md:items-center md:justify-between mb-8"
    >
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
                <h1 class="text-4xl font-bold">{{ code.code }}</h1>
                {% if code.is_expired %}
                <span class="badge badge-error badge-lg gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                    </svg>
                    Expired
                </span>
                {% else %}
                <span class="badge badge-success badge-lg gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"
                        />
                    </svg>
                    Active
                </span>
                {% endif %}
            </div>
            {% if code.has_description %}
            <p class="text-base-content/70 text-lg">{{ code.description }}</p>
            {% endif %}
        </div>
        <div class="mt-4 md:mt-0 flex gap-2">
            <button
                onclick="deleteModal.showModal()"
                class="btn btn-error btn-outline gap-2"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                </svg>
                Delete
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats stats-vertical lg:stats-horizontal shadow w-full mb-8">
        <div class="stat">
            <div class="stat-figure text-primary">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-8 w-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                    />
                </svg>
            </div>
            <div class="stat-title">Resources</div>
            <div class="stat-value text-primary">{{ code.resource_count }}</div>
            <div class="stat-desc">Individual resources</div>
        </div>

        <div class="stat">
            <div class="stat-figure text-secondary">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-8 w-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    />
                </svg>
            </div>
            <div class="stat-title">Total Views</div>
            <div class="stat-value text-secondary">{{ code.usage_count }}</div>
            <div class="stat-desc">All time</div>
        </div>

        <div class="stat">
            <div class="stat-figure text-accent">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-8 w-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                    />
                </svg>
            </div>
            <div class="stat-title">Created</div>
            <div class="stat-value text-accent text-2xl">
                {{ code.created_at_human }}
            </div>
            <div class="stat-desc">{{ code.created_at_formatted }}</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Details -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Code Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-xl mb-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        Information
                    </h2>

                    <div class="space-y-3">
                        <div>
                            <div
                                class="text-xs text-base-content/60 uppercase font-semibold mb-1"
                            >
                                Code
                            </div>
                            <div class="font-mono text-sm">{{ code.code }}</div>
                        </div>

                        <div class="divider my-2"></div>

                        <div>
                            <div
                                class="text-xs text-base-content/60 uppercase font-semibold mb-1"
                            >
                                Status
                            </div>
                            <div>
                                {% if code.is_expired %}
                                <span class="badge badge-error">Expired</span>
                                {% else %}
                                <span class="badge badge-success">Active</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="divider my-2"></div>

                        <div>
                            <div
                                class="text-xs text-base-content/60 uppercase font-semibold mb-1"
                            >
                                Expiration
                            </div>
                            <div class="text-sm">
                                {% if code.has_expiration %} {{
                                code.expires_at_human }}
                                <div class="text-xs text-base-content/60">
                                    {{ code.expires_at_formatted }}
                                </div>
                                {% else %}
                                <span class="text-base-content/60"
                                    >Never expires</span
                                >
                                {% endif %}
                            </div>
                        </div>

                        <div class="divider my-2"></div>

                        <div>
                            <div
                                class="text-xs text-base-content/60 uppercase font-semibold mb-1"
                            >
                                Access Type
                            </div>
                            <div class="text-sm">
                                <span class="badge badge-ghost gap-1">
                                    üìã Individual Resources
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Resources -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                            />
                        </svg>
                        Resources ({{ code.resource_count }})
                    </h2>

                    {% if code.resource_count == 0 %}
                    <!-- Empty State -->
                    <div class="text-center py-12">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-24 w-24 mx-auto text-base-content/30 mb-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                            />
                        </svg>
                        <h3 class="text-xl font-bold mb-2">No Resources</h3>
                        <p class="text-base-content/70">
                            This access code has no resources assigned.
                        </p>
                    </div>
                    {% else %}
                    <!-- Resource List -->
                    <div class="space-y-3">
                        {% for item in code.media_items %}
                        <div
                            class="card bg-base-200 hover:bg-base-300 transition-colors"
                        >
                            <div class="card-body p-4">
                                <div class="flex items-start gap-4">
                                    <!-- Icon -->
                                    <div class="text-4xl">
                                        {% if item.media_type == "video" %}üé•{%
                                        else %}üñºÔ∏è{% endif %}
                                    </div>

                                    <!-- Details -->
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-lg mb-1">
                                            {{ item.media_slug }}
                                        </h3>
                                        <div
                                            class="flex items-center gap-2 text-sm text-base-content/60"
                                        >
                                            <span class="badge badge-sm"
                                                >{{ item.media_type }}</span
                                            >
                                        </div>

                                        <!-- URL -->
                                        <div class="mt-2">
                                            <div
                                                class="flex gap-2 items-center"
                                            >
                                                <input
                                                    type="text"
                                                    value="{{ base_url }}{% if item.media_type == "video" %}/watch{% else %}/images{% endif %}/{{ item.media_slug }}?code={{ code.code }}"
                                                    readonly
                                                    class="input input-sm input-bordered flex-1 text-xs font-mono"
                                                    id="url-{{ loop.index0 }}"
                                                />
                                                <button
                                                    onclick="copyUrl({{ loop.index0 }})"
                                                    class="btn btn-sm btn-square btn-ghost"
                                                    title="Copy URL"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action -->
                                    <div>
                                        <a
                                            href="{% if item.media_type == "video" %}/watch{% else %}/images{% endif %}/{{ item.media_slug }}?code={{ code.code }}"
                                            target="_blank"
                                            class="btn btn-sm btn-primary gap-1"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                                />
                                            </svg>
                                            Open
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Delete Access Code?</h3>
        <p class="mb-4">
            Are you sure you want to delete the access code
            <strong class="font-mono">{{ code.code }}</strong>?
        </p>

        <div class="alert alert-warning mb-4">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="stroke-current shrink-0 h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
            </svg>
            <div>
                <div class="font-bold">This action cannot be undone</div>
                <div class="text-sm">
                    Users with this code will immediately lose access to {{
                    code.resource_count }} resources.
                </div>
            </div>
        </div>

        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <button onclick="confirmDelete()" class="btn btn-error">
                Delete Access Code
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    function copyUrl(index) {
        const input = document.getElementById("url-" + index);
        input.select();
        document.execCommand("copy");
        showToast("URL copied to clipboard!");
    }

    async function confirmDelete() {
        try {
            const response = await fetch("/api/access-codes/{{ code.code }}", {
                method: "DELETE",
            });

            if (response.ok) {
                showToast("Access code deleted successfully!");
                setTimeout(function () {
                    window.location.href = "/access/codes";
                }, 1000);
            } else {
                showToast("Failed to delete access code!");
            }
        } catch (error) {
            console.error("Error deleting code:", error);
            showToast("Network error. Please try again!");
        }

        deleteModal.close();
    }

    function showToast(message) {
        const toast = document.createElement("div");
        toast.className =
            "alert alert-success fixed top-4 right-4 w-auto shadow-lg z-50";
        toast.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>' +
            message +
            "</span>";
        document.body.appendChild(toast);
        setTimeout(function () {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}
