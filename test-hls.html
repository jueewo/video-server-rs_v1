<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Live Stream - WebRTC (Ultra Low Latency)</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background: #1a1a1a;
                color: #fff;
            }
            h1 {
                color: #4caf50;
            }
            .mode-selector {
                background: #2d2d2d;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
            }
            .mode-selector button {
                margin-right: 10px;
                padding: 10px 20px;
            }
            .mode-selector button.active {
                background: #4caf50;
                color: white;
            }
            #video-container {
                margin: 20px 0;
                background: #000;
                border-radius: 8px;
                overflow: hidden;
            }
            video {
                width: 100%;
                max-width: 800px;
                display: block;
                background: #000;
            }
            #log {
                background: #2d2d2d;
                border: 1px solid #444;
                border-radius: 4px;
                padding: 15px;
                height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 12px;
                margin-top: 20px;
            }
            .log-entry {
                padding: 5px 0;
                border-bottom: 1px solid #3a3a3a;
            }
            .log-info {
                color: #4caf50;
            }
            .log-warn {
                color: #ff9800;
            }
            .log-error {
                color: #f44336;
            }
            .controls {
                margin: 20px 0;
            }
            button {
                background: #4caf50;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
                font-size: 14px;
            }
            button:hover {
                background: #45a049;
            }
            button:disabled {
                background: #666;
                cursor: not-allowed;
            }
            .info-box {
                background: #2d2d2d;
                padding: 15px;
                border-radius: 4px;
                margin: 20px 0;
            }
            .info-box h3 {
                margin-top: 0;
                color: #4caf50;
            }
            .latency-badge {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 4px;
                font-weight: bold;
                margin-left: 10px;
            }
            .latency-low {
                background: #4caf50;
                color: white;
            }
            .latency-medium {
                background: #ff9800;
                color: white;
            }
        </style>
    </head>
    <body>
        <h1>üé• Live Stream Player</h1>

        <div class="mode-selector">
            <h3>Select Streaming Mode:</h3>
            <button
                id="btnWebRTC"
                class="active"
                onclick="switchMode('webrtc')"
            >
                WebRTC
                <span class="latency-badge latency-low">&lt;1s latency</span>
            </button>
            <button id="btnHLS" onclick="switchMode('hls')">
                HLS
                <span class="latency-badge latency-medium">2-4s latency</span>
            </button>
        </div>

        <div id="video-container">
            <video id="video" controls autoplay playsinline></video>
        </div>

        <div class="controls">
            <button onclick="startStream()">‚ñ∂Ô∏è Start Stream</button>
            <button onclick="stopStream()">‚èπÔ∏è Stop Stream</button>
            <button onclick="toggleMute()">üîä Toggle Mute</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="info-box">
            <h3>Status</h3>
            <p id="status">Ready to stream</p>
        </div>

        <div class="info-box">
            <h3>Debug Log</h3>
            <div id="log"></div>
        </div>

        <!-- HLS.js library (for HLS mode) -->
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

        <script>
            const video = document.getElementById("video");
            const logDiv = document.getElementById("log");
            const statusDiv = document.getElementById("status");

            let currentMode = "webrtc"; // default to WebRTC
            let hls = null;
            let pc = null; // WebRTC PeerConnection
            let restartInProgress = false;

            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement("div");
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
                console.log(`[${type.toUpperCase()}]`, message);
            }

            function updateStatus(message, isError = false) {
                statusDiv.textContent = message;
                statusDiv.style.color = isError ? "#f44336" : "#4CAF50";
            }

            function clearLog() {
                logDiv.innerHTML = "";
                log("Log cleared", "info");
            }

            function toggleMute() {
                video.muted = !video.muted;
                log(`Video ${video.muted ? "muted" : "unmuted"}`, "info");
            }

            function switchMode(mode) {
                if (currentMode === mode) return;

                currentMode = mode;
                document
                    .getElementById("btnWebRTC")
                    .classList.toggle("active", mode === "webrtc");
                document
                    .getElementById("btnHLS")
                    .classList.toggle("active", mode === "hls");

                log(`Switched to ${mode.toUpperCase()} mode`, "info");
                stopStream();
            }

            // ========================================
            // WebRTC Implementation (WHEP Protocol)
            // ========================================
            async function startWebRTC() {
                log("Starting WebRTC stream...", "info");
                updateStatus("Connecting via WebRTC...");

                try {
                    // Create RTCPeerConnection
                    pc = new RTCPeerConnection({
                        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
                    });

                    // Handle incoming tracks
                    pc.ontrack = (event) => {
                        log(`Received ${event.track.kind} track`, "info");
                        if (!video.srcObject) {
                            video.srcObject = event.streams[0];
                            updateStatus("üé• Streaming (WebRTC - <1s latency)");
                            // Ensure audio is unmuted
                            video.muted = false;
                            video.volume = 1.0;
                        }
                    };

                    // Handle ICE connection state
                    pc.oniceconnectionstatechange = () => {
                        log(`ICE state: ${pc.iceConnectionState}`, "info");
                        if (
                            pc.iceConnectionState === "disconnected" ||
                            pc.iceConnectionState === "failed"
                        ) {
                            updateStatus("Connection lost", true);
                            if (!restartInProgress) {
                                restartInProgress = true;
                                setTimeout(() => {
                                    log("Attempting to reconnect...", "warn");
                                    stopStream();
                                    startStream();
                                    restartInProgress = false;
                                }, 3000);
                            }
                        } else if (pc.iceConnectionState === "connected") {
                            updateStatus("üé• Streaming (WebRTC - <1s latency)");
                        }
                    };

                    // Add transceivers for video and audio
                    pc.addTransceiver("video", { direction: "recvonly" });
                    pc.addTransceiver("audio", { direction: "recvonly" });

                    // Create offer
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    // Send offer to MediaMTX via WHEP protocol
                    const whepUrl = "http://localhost:8889/live/whep";
                    log(`Sending WHEP request to: ${whepUrl}`, "info");

                    const response = await fetch(whepUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/sdp",
                        },
                        body: offer.sdp,
                    });

                    if (!response.ok) {
                        throw new Error(
                            `WHEP request failed: ${response.status}`,
                        );
                    }

                    // Set remote description from answer
                    const answer = await response.text();
                    await pc.setRemoteDescription({
                        type: "answer",
                        sdp: answer,
                    });

                    log("WebRTC connection established", "info");
                } catch (error) {
                    log(`WebRTC error: ${error.message}`, "error");
                    updateStatus(`WebRTC error: ${error.message}`, true);
                }
            }

            function stopWebRTC() {
                if (pc) {
                    pc.close();
                    pc = null;
                    log("WebRTC connection closed", "info");
                }
                if (video.srcObject) {
                    video.srcObject
                        .getTracks()
                        .forEach((track) => track.stop());
                    video.srcObject = null;
                }
            }

            // ========================================
            // HLS Implementation
            // ========================================
            function startHLS() {
                const streamUrl = "http://localhost:3000/hls/live/index.m3u8";

                if (hls) {
                    hls.destroy();
                    log("Destroyed previous HLS instance", "info");
                }

                if (Hls.isSupported()) {
                    log("Starting HLS stream...", "info");
                    updateStatus("Connecting via HLS...");

                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        maxBufferLength: 3,
                        maxMaxBufferLength: 6,
                        liveSyncDurationCount: 1,
                        liveMaxLatencyDurationCount: 3,
                    });

                    hls.on(Hls.Events.MANIFEST_LOADED, () => {
                        log("HLS manifest loaded", "info");
                        updateStatus("üì° Streaming (HLS - 2-4s latency)");
                    });

                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            log(`HLS ERROR: ${data.details}`, "error");
                            updateStatus(`HLS error: ${data.details}`, true);

                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    log(
                                        "Attempting to recover from network error...",
                                        "warn",
                                    );
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    log(
                                        "Attempting to recover from media error...",
                                        "warn",
                                    );
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    log("Unrecoverable error", "error");
                                    hls.destroy();
                                    break;
                            }
                        }
                    });

                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);

                    video.addEventListener("playing", () => {
                        log("Video playing", "info");
                        updateStatus("üì° Streaming (HLS - 2-4s latency)");
                        // Ensure audio is unmuted
                        video.muted = false;
                        video.volume = 1.0;
                    });
                } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                    log("Using native HLS support (Safari)", "info");
                    video.src = streamUrl;
                    video.muted = false;
                    video.volume = 1.0;
                    updateStatus("üì° Streaming (HLS - native)");
                } else {
                    log("HLS not supported", "error");
                    updateStatus("HLS not supported", true);
                }
            }

            function stopHLS() {
                if (hls) {
                    hls.destroy();
                    hls = null;
                    log("HLS instance destroyed", "info");
                }
                video.src = "";
            }

            // ========================================
            // Main Control Functions
            // ========================================
            function startStream() {
                log(
                    `Starting stream in ${currentMode.toUpperCase()} mode`,
                    "info",
                );
                stopStream(); // Stop any existing stream

                if (currentMode === "webrtc") {
                    startWebRTC();
                } else {
                    startHLS();
                }
            }

            function stopStream() {
                if (currentMode === "webrtc") {
                    stopWebRTC();
                } else {
                    stopHLS();
                }
                updateStatus("Stopped");
                log("Stream stopped", "info");
            }

            // Auto-start with WebRTC on page load
            window.addEventListener("load", () => {
                log("Page loaded - ready to stream", "info");
                log("üí° Tip: WebRTC mode provides <1 second latency!", "info");
                // Auto-start the stream
                setTimeout(() => startStream(), 500);
            });
        </script>
    </body>
</html>
