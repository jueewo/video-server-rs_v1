{% extends "base-tailwind.html" %} {% block title %}Edit Image{% endblock %} {%
block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl" x-data="imageEdit()">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h1 class="card-title text-3xl mb-4">‚úèÔ∏è Edit Image</h1>

            <div class="mb-4">
                <img
                    src="/images/{{ image.slug }}"
                    alt="{{ image.title }}"
                    class="max-w-md rounded-lg shadow-lg"
                />
            </div>

            <div class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Title</span>
                    </label>
                    <input
                        type="text"
                        x-model="formData.title"
                        class="input input-bordered"
                    />
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold"
                            >Assign to Group</span
                        >
                    </label>
                    <select
                        x-model="formData.groupId"
                        class="select select-bordered"
                        :disabled="loadingGroups"
                    >
                        <option value="">No group (Private)</option>
                        <template
                            x-for="group in availableGroups"
                            :key="group.id"
                        >
                            <option
                                :value="String(group.id)"
                                x-text="'üìö ' + group.name"
                            ></option>
                        </template>
                    </select>
                    <label class="label" x-show="loadingGroups">
                        <span class="label-text-alt">Loading groups...</span>
                    </label>
                    <label
                        class="label"
                        x-show="!loadingGroups && availableGroups.length === 0"
                    >
                        <span class="label-text-alt">No groups available</span>
                    </label>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input
                            type="checkbox"
                            x-model="formData.isPublic"
                            class="checkbox checkbox-primary"
                        />
                        <span class="label-text font-semibold"
                            >Make Public</span
                        >
                    </label>
                </div>

                <!-- Tags Section -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text font-semibold">Tags</span>
                        <span class="label-text-alt"
                            >Help others discover your image</span
                        >
                    </label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            x-model="tagInput"
                            @keydown.enter.prevent="addTag"
                            placeholder="Type tag name and press Enter..."
                            class="input input-bordered flex-1"
                        />
                        <button
                            type="button"
                            @click="addTag"
                            class="btn btn-primary"
                        >
                            Add
                        </button>
                    </div>
                </div>

                <!-- Selected Tags -->
                <div
                    class="flex flex-wrap gap-2 mt-4"
                    x-show="formData.tags.length > 0"
                >
                    <template
                        x-for="(tag, index) in formData.tags"
                        :key="index"
                    >
                        <div class="badge badge-primary badge-lg gap-2">
                            <span
                                x-text="typeof tag === 'object' ? tag.name : tag"
                            ></span>
                            <button
                                type="button"
                                @click="removeTag(index)"
                                class="btn btn-ghost btn-xs btn-circle"
                            >
                                ‚úï
                            </button>
                        </div>
                    </template>
                </div>

                <div
                    x-show="formData.tags.length === 0"
                    class="text-center py-2 text-base-content/60 text-sm"
                >
                    No tags added yet
                </div>
            </div>

            <!-- Success message -->
            <div x-show="successMessage" class="alert alert-success mt-4">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="stroke-current shrink-0 h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span x-text="successMessage"></span>
            </div>

            <!-- Error message -->
            <div x-show="errorMessage" class="alert alert-error mt-4">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="stroke-current shrink-0 h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span x-text="errorMessage"></span>
            </div>

            <div class="card-actions justify-end mt-6">
                <button
                    @click="handleSubmit"
                    class="btn btn-primary"
                    :disabled="saving"
                >
                    <span x-text="saving ? 'Saving...' : 'Save Changes'"></span>
                </button>
                <a href="/images/view/{{ image.slug }}" class="btn btn-ghost"
                    >Cancel</a
                >
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
    function imageEdit() {
        return {
            saving: false,
            formData: {
                title: '{{ image.title }}',
                isPublic: {{ image.is_public }},
                groupId: '{{ image.group_id_str }}',
                tags: []
            },
            tagInput: '',
            successMessage: '',
            errorMessage: '',
            availableGroups: [],
            loadingGroups: false,

            async init() {
                await this.loadGroups();
                await this.loadTags();
                // Watch for group changes
                this.$watch('formData.groupId', (value) => {
                    console.log('Group changed to:', value, typeof value);
                });
            },

            async loadTags() {
                try {
                    const response = await fetch('/api/images/{{ image.id }}/tags');
                    if (response.ok) {
                        const data = await response.json();
                        // Extract tag names from tag objects
                        this.formData.tags = (data.tags || []).map(tag => typeof tag === 'object' ? tag.name : tag);
                        console.log('Tags loaded:', this.formData.tags);
                    }
                } catch (error) {
                    console.error('Failed to load tags:', error);
                }
            },

            async loadGroups() {
                this.loadingGroups = true;
                try {
                    console.log('Loading groups...');
                    const response = await fetch('/api/groups', {
                        credentials: 'same-origin'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Groups loaded:', data);
                        this.availableGroups = data || [];
                        console.log('Available groups:', this.availableGroups.length);
                    } else {
                        console.error('Failed to load groups:', response.status);
                        this.errorMessage = 'Failed to load groups';
                    }
                } catch (error) {
                    console.error('Failed to load groups:', error);
                    this.errorMessage = 'Failed to load groups: ' + error.message;
                } finally {
                    this.loadingGroups = false;
                }
            },

            addTag() {
                const tag = this.tagInput.trim().toLowerCase();
                if (tag && !this.formData.tags.includes(tag)) {
                    this.formData.tags.push(tag);
                    this.tagInput = '';
                    this.successMessage = `Tag "${tag}" added`;
                    setTimeout(() => this.successMessage = '', 2000);
                }
            },

            removeTag(index) {
                const tag = this.formData.tags[index];
                this.formData.tags.splice(index, 1);
                this.successMessage = `Tag "${tag}" removed`;
                setTimeout(() => this.successMessage = '', 2000);
            },

            async handleSubmit() {
                this.saving = true;
                this.errorMessage = '';
                this.successMessage = '';
                try {
                    // Convert values to proper types for backend
                    const payload = {
                        title: this.formData.title,
                        isPublic: this.formData.isPublic ? 'true' : 'false',
                        groupId: String(this.formData.groupId),
                        tags: this.formData.tags // Include tags in main payload
                    };

                    console.log('Sending payload:', payload);
                    console.log('Current groupId:', this.formData.groupId);
                    console.log('Tags:', this.formData.tags);

                    const response = await fetch('/api/images/{{ image.id }}', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Save successful:', result);
                        this.successMessage = 'Image and tags updated successfully!';
                        // Redirect after showing success message briefly
                        setTimeout(() => {
                            window.location.href = '/images/view/{{ image.slug }}';
                        }, 500);
                    } else {
                        const errorText = await response.text();
                        console.error('Save failed:', response.status, errorText);
                        this.errorMessage = `Failed to save (${response.status}): ${errorText}`;
                    }
                } catch (error) {
                    console.error('Failed to save:', error);
                    this.errorMessage = 'Failed to save: ' + error.message;
                } finally {
                    this.saving = false;
                }
            }
        };
    }
</script>
{% endblock %}
