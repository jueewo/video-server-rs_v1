{% extends "base-tailwind.html" %}
{% block title %}Upload Video - Video Server{% endblock %}

{% block extra_head %}
<style>
    .drag-over {
        @apply border-primary bg-primary/10;
    }

    .upload-progress {
        transition: width 0.3s ease;
    }

    .video-preview {
        max-height: 400px;
    }

    .tag-input-wrapper {
        position: relative;
    }

    .tag-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl" x-data="videoUpload()">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <a href="/videos" class="btn btn-ghost btn-sm gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Videos
            </a>
        </div>
        <h1 class="text-4xl font-bold text-base-content mb-2">üì§ Upload Video</h1>
        <p class="text-lg text-base-content/70">Share your content with the world</p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8">
        <ul class="steps steps-horizontal w-full">
            <li class="step" :class="step >= 1 ? 'step-primary' : ''">Select Video</li>
            <li class="step" :class="step >= 2 ? 'step-primary' : ''">Add Details</li>
            <li class="step" :class="step >= 3 ? 'step-primary' : ''">Review & Upload</li>
        </ul>
    </div>

    <form @submit.prevent="handleSubmit" class="space-y-6">
        <!-- Step 1: File Selection -->
        <div x-show="step === 1" class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">Choose Your Video</h2>

                <!-- Drag and Drop Zone -->
                <div
                    class="border-4 border-dashed border-base-300 rounded-xl p-12 text-center transition-all duration-300"
                    :class="{ 'drag-over': isDragging }"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleDrop"
                    x-show="!selectedFile"
                >
                    <div class="text-6xl mb-4">üé¨</div>
                    <h3 class="text-2xl font-bold mb-2">Drag & Drop Your Video</h3>
                    <p class="text-base-content/60 mb-4">or click to browse</p>
                    <input
                        type="file"
                        id="videoFile"
                        accept="video/*"
                        @change="handleFileSelect"
                        class="hidden"
                    >
                    <label for="videoFile" class="btn btn-primary btn-lg gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Choose File
                    </label>
                    <p class="text-sm text-base-content/50 mt-4">
                        Supported formats: MP4, WebM, AVI, MOV, MKV (Max 2GB)
                    </p>
                </div>

                <!-- File Preview -->
                <div x-show="selectedFile" class="space-y-4">
                    <!-- Video Preview Player -->
                    <div class="bg-base-300 rounded-xl overflow-hidden video-preview">
                        <video
                            x-ref="videoPreview"
                            controls
                            class="w-full"
                            @loadedmetadata="extractMetadata"
                        >
                            Your browser does not support the video tag.
                        </video>
                    </div>

                    <!-- File Info Card -->
                    <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                        <div class="stat">
                            <div class="stat-title">File Name</div>
                            <div class="stat-value text-lg" x-text="selectedFile?.name"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">File Size</div>
                            <div class="stat-value text-lg" x-text="formatFileSize(selectedFile?.size)"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Duration</div>
                            <div class="stat-value text-lg" x-text="metadata.duration || 'Calculating...'"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Resolution</div>
                            <div class="stat-value text-lg" x-text="metadata.resolution || 'Detecting...'"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button type="button" @click="clearFile" class="btn btn-outline gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Remove & Choose Another
                        </button>
                        <button type="button" @click="step = 2" class="btn btn-primary flex-1 gap-2">
                            Next: Add Details
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Metadata Form -->
        <div x-show="step === 2" class="space-y-6">
            <!-- Basic Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üìù Video Details</h2>

                    <!-- Title -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Title *</span>
                            <span class="label-text-alt" x-text="formData.title.length + '/100'"></span>
                        </label>
                        <input
                            type="text"
                            x-model="formData.title"
                            placeholder="Enter a catchy title for your video"
                            class="input input-bordered w-full"
                            maxlength="100"
                            required
                        >
                    </div>

                    <!-- Slug (auto-generated) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">URL Slug *</span>
                            <span class="label-text-alt text-info">Auto-generated from title</span>
                        </label>
                        <input
                            type="text"
                            x-model="formData.slug"
                            placeholder="url-friendly-slug"
                            class="input input-bordered w-full"
                            pattern="[a-z0-9-]+"
                            required
                        >
                        <label class="label">
                            <span class="label-text-alt">Will be accessible at: /watch/<span x-text="formData.slug || 'your-slug'"></span></span>
                        </label>
                    </div>

                    <!-- Short Description -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Short Description</span>
                            <span class="label-text-alt" x-text="formData.shortDescription.length + '/200'"></span>
                        </label>
                        <input
                            type="text"
                            x-model="formData.shortDescription"
                            placeholder="Brief description for preview cards (max 200 characters)"
                            class="input input-bordered w-full"
                            maxlength="200"
                        >
                    </div>

                    <!-- Full Description -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Full Description</span>
                            <span class="label-text-alt" x-text="formData.description.length + '/2000'"></span>
                        </label>
                        <textarea
                            x-model="formData.description"
                            class="textarea textarea-bordered h-32"
                            placeholder="Detailed description of your video content..."
                            maxlength="2000"
                        ></textarea>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üè∑Ô∏è Tags</h2>

                    <div class="form-control tag-input-wrapper">
                        <label class="label">
                            <span class="label-text font-semibold">Add Tags</span>
                            <span class="label-text-alt">Help others discover your video</span>
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="tagInput"
                                @input="searchTags"
                                @keydown.enter.prevent="addTag"
                                placeholder="Type to search or create tags..."
                                class="input input-bordered flex-1"
                            >
                            <button type="button" @click="addTag" class="btn btn-primary">Add</button>
                        </div>

                        <!-- Tag Suggestions -->
                        <div
                            x-show="tagSuggestions.length > 0"
                            class="tag-suggestions mt-2 menu bg-base-200 rounded-box shadow-lg"
                        >
                            <template x-for="tag in tagSuggestions" :key="tag">
                                <li><a @</li>click="addTagFromSuggestion(tag)" x-text="tag"></a></li>
                            </template>
                        </div>

                        <!-- Selected Tags -->
                        <div class="flex flex-wrap gap-2 mt-4" x-show="formData.tags.length > 0">
                            <template x-for="(tag, index) in formData.tags" :key="index">
                                <div class="badge badge-primary badge-lg gap-2">
                                    <span x-text="tag"></span>
                                    <button type="button" @click="removeTag(index)" class="btn btn-ghost btn-xs btn-circle">‚úï</button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category & Settings -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">‚öôÔ∏è Settings</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Category -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Category</span>
                            </label>
                            <select x-model="formData.category" class="select select-bordered">
                                <option value="">Select category...</option>
                                <option value="education">üìö Education</option>
                                <option value="entertainment">üé≠ Entertainment</option>
                                <option value="music">üéµ Music</option>
                                <option value="gaming">üéÆ Gaming</option>
                                <option value="sports">‚öΩ Sports</option>
                                <option value="news">üì∞ News</option>
                                <option value="technology">üíª Technology</option>
                                <option value="tutorial">üéì Tutorial</option>
                                <option value="vlog">üìπ Vlog</option>
                                <option value="other">üì¶ Other</option>
                            </select>
                        </div>

                        <!-- Language -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Language</span>
                            </label>
                            <select x-model="formData.language" class="select select-bordered">
                                <option value="en">üá¨üáß English</option>
                                <option value="es">üá™üá∏ Spanish</option>
                                <option value="fr">üá´üá∑ French</option>
                                <option value="de">üá©üá™ German</option>
                                <option value="it">üáÆüáπ Italian</option>
                                <option value="pt">üáµüáπ Portuguese</option>
                                <option value="ru">üá∑üá∫ Russian</option>
                                <option value="ja">üáØüáµ Japanese</option>
                                <option value="zh">üá®üá≥ Chinese</option>
                                <option value="ko">üá∞üá∑ Korean</option>
                                <option value="other">üåç Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Checkboxes -->
                    <div class="divider"></div>
                    <div class="space-y-3">
                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" x-model="formData.isPublic" class="checkbox checkbox-primary">
                                <div></div>
                                    <span class="label-text font-semibold">Make Public</span>
                                    <p class="text-xs text-base-content/60">Anyone can view this video</p>
                                </div>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" x-model="formData.featured" class="checkbox checkbox-secondary">
                                <div>
                                    <span class="label-text font-semibold">Featured Video</span>
                                    <p class="text-xs text-base-content/60">Highlight this video on the homepage</p>
                                </div>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" x-model="formData.allowComments" class="checkbox checkbox-accent">
                                <div>
                                    <span class="label-text font-semibold">Allow Comments</span>
                                    <p class="text-xs text-base-content/60">Users can comment on this video</p>
                                </div>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" x-model="formData.allowDownload" class="checkbox">
                                <div>
                                    <span class="label-text font-semibold">Allow Download</span>
                                    <p class="text-xs text-base-content/60">Users can download this video</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Access & Sharing -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üîê Access & Sharing</h2>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Access Group</span>
                            <span class="label-text-alt text-base-content/60">Optional</span>
                        </label>
                        <select x-model="formData.groupId" class="select select-bordered">
                            <option value="">No group (Private to me only)</option>
                            <template x-for="group in groups" :key="group.id">
                                <option :value="group.id" x-text="`${group.name} (${group.member_count} members)`"></option>
                            </template>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">Assign this video to a group for team collaboration</span>
                        </label>
                    </div>

                    <div class="alert alert-info mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <div class="text-sm">
                                <strong>Privacy:</strong> Selecting a group allows all group members to view this video.
                                Leave unselected to keep it private to you only.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex gap-4">
                <button type="button" @click="step = 1" class="btn btn-outline gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Back
                </button>
                <button type="button" @click="step = 3" class="btn btn-primary flex-1 gap-2">
                    Next: Review
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Step 3: Review & Upload -->
        <div x-show="step === 3" class="space-y-6">
            <!-- Review Card -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">üëÄ Review Your Upload</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Video Preview -->
                        <div>
                            <h3 class="font-bold mb-2">Video Preview</h3>
                            <div class="bg-base-300 rounded-xl overflow-hidden aspect-video">
                                <video controls class="w-full h-full" x-ref="reviewPreview">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        </div>

                        <!-- Details -->
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-sm text-base-content/60 mb-1">Title</h4>
                                <p x-text="formData.title" class="text-lg"></p>
                            </div>

                            <div>
                                <h4 class="font-bold text-sm text-base-content/60 mb-1">URL</h4>
                                <p class="text-sm font-mono">/watch/<span x-text="formData.slug"></span></p>
                            </div>

                            <div x-show="formData.shortDescription">
                                <h4 class="font-bold text-sm text-base-content/60 mb-1">Short Description</h4>
                                <p x-text="formData.shortDescription" class="text-sm"></p>
                            </div>

                            <div x-show="formData.tags.length > 0">
                                <h4 class="font-bold text-sm text-base-content/60 mb-1">Tags</h4>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="tag in formData.tags" :key="tag">
                                        <span class="badge badge-primary" x-text="tag"></span>
                                    </template>
                                </div>
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-bold">Category:</span>
                                    <span x-text="formData.category || 'None'"></span>
                                </div>
                                <div>
                                    <span class="font-bold">Language:</span>
                                    <span x-text="formData.language"></span>
                                </div>
                                <div>
                                    <span class="font-bold">Public:</span>
                                    <span x-text="formData.isPublic ? 'Yes' : 'No'"></span>
                                </div>
                                <div>
                                    <span class="font-bold">Featured:</span>
                                    <span x-text="formData.featured ? 'Yes' : 'No'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div x-show="uploading" class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-xl mb-4">
                        <span class="loading loading-spinner loading-md"></span>
                        Uploading...
                    </h3>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Progress</span>
                            <span x-text="uploadProgress + '%'"></span>
                        </div>
                        <progress class="progress progress-primary w-full" :value="uploadProgress" max="100"></progress>
                        <p class="text-sm text-base-content/60" x-text="uploadStatus"></p>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            <div x-show="uploadSuccess" class="alert alert-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h</div>3 class="font-bold">Upload Successful!</h3>
                    <div class="text-xs">Your video has been uploaded and is being processed.</div>
                </div>
            </div>

            <!-- Error Message -->
            <div x-show="uploadError" class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="font-bold">Upload Failed</h3>
                    <div class="text-xs" x-text="errorMessage"></div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex gap-4">
                <button type="button" @click="step = 2" class="btn btn-outline gap-2" :disabled="uploading">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Back to Edit
                </button>
                <button
                    type="submit"
                    class="btn btn-success flex-1 gap-2"
                    :disabled="uploading || uploadSuccess"
                    x-show="!uploadSuccess"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />
                    </svg>
                    <span x-text="uploading ? 'Uploading...' : 'Upload Video'"></span>
                </button>
                <a
                    x-show="uploadSuccess"
                    :href="'/watch/' + formData.slug"
                    class="btn btn-primary flex-1 gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Watch Video
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function videoUpload() {
    return {
        step: 1,
        selectedFile: null,
        isDragging: false,
        metadata: {
            duration: '',
            resolution: '',
            fileSize: 0
        },
        formData: {
            title: '',
            slug: '',
            description: '',
            shortDescription: '',
            category: '',
            language: 'en',
            tags: [],
            isPublic: true,
            featured: false,
            allowComments: true,
            allowDownload: false,
            groupId: ''
        },
        groups: [],
        tagInput: '',
        tagSuggestions: [],
        uploading: false,
        uploadProgress: 0,
        uploadStatus: '',
        uploadSuccess: false,
        uploadError: false,
        errorMessage: '',

        init() {
            // Auto-generate slug from title
            this.$watch('formData.title', value => {
                if (!this.formData.slug || this.formData.slug === this.slugify(value)) {
                    this.formData.slug = this.slugify(value);
                }
            });

            // Load groups
            this.loadGroups();
        },

        async loadGroups() {
            try {
                const response = await fetch('/api/groups');
                if (response.ok) {
                    this.groups = await response.json();
                }
            } catch (error) {
                console.error('Failed to load groups:', error);
            }
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.setFile(file);
            }
        },

        handleDrop(event) {
            this.isDragging = false;
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                this.setFile(file);
            } else {
                showToast('Please drop a valid video file', 'error');
            }
        },

        setFile(file) {
            if (file.size > 2 * 1024 * 1024 * 1024) { // 2GB limit
                showToast('File size exceeds 2GB limit', 'error');
                return;
            }

            this.selectedFile = file;
            this.metadata.fileSize = file.size;

            // Set default title from filename
            if (!this.formData.title) {
                this.formData.title = file.name.replace(/\.[^/.]+$/, '');
            }

            // Load video for preview
            const videoUrl = URL.createObjectURL(file);
            this.$refs.videoPreview.src = videoUrl;
        },

        clearFile() {
            this.selectedFile = null;
            this.metadata = { duration: '', resolution: '', fileSize: 0 };
            this.$refs.videoPreview.src = '';
            document.getElementById('videoFile').value = '';
        },

        extractMetadata(event) {
            const video = event.target;

            // Duration
            const duration = Math.floor(video.duration);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;

            if (hours > 0) {
                this.metadata.duration = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                this.metadata.duration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // Resolution
            this.metadata.resolution = `${video.videoWidth}x${video.videoHeight}`;
        },

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        slugify(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        },

        searchTags() {
            // Simulate tag search (in production, call API)
            const query = this.tagInput.toLowerCase();
            if (query.length < 2) {
                this.tagSuggestions = [];
                return;
            }

            // Mock suggestions
            const allTags = ['tutorial', 'education', 'entertainment', 'music', 'gaming',
                           'technology', 'programming', 'rust', 'web-development', 'coding',
                           'vlog', 'comedy', 'review', 'documentary', 'animation'];

            this.tagSuggestions = allTags
                .filter(tag => tag.includes(query) && !this.formData.tags.includes(tag))
                .slice(0, 5);
        },

        addTag() {
            const tag = this.tagInput.trim().toLowerCase();
            if (tag && !this.formData.tags.includes(tag)) {
                this.formData.tags.push(tag);
                this.tagInput = '';
                this.tagSuggestions = [];
                showToast(`Tag "${tag}" added`, 'success');
            }
        },

        addTagFromSuggestion(tag) {
            this.tagInput = tag;
            this.addTag();
        },

        removeTag(index) {
            this.formData.tags.splice(index, 1);
        },

        async handleSubmit() {
            if (!this.selectedFile) {
                showToast('Please select a video file', 'error');
                return;
            }

            if (!this.formData.title || !this.formData.slug) {
                showToast('Please fill in required fields', 'error');
                return;
            }

            this.uploading = true;
            this.uploadProgress = 0;
            this.uploadStatus = 'Preparing upload...';
            this.uploadError = false;
            this.uploadSuccess = false;

            try {
                const formData = new FormData();
                formData.append('video', this.selectedFile);
                formData.append('title', this.formData.title);
                formData.append('slug', this.formData.slug);
                formData.append('description', this.formData.description);
                formData.append('short_description', this.formData.shortDescription);
                formData.append('category', this.formData.category);
                formData.append('language', this.formData.language);
                formData.append('tags', JSON.stringify(this.formData.tags));
                formData.append('is_public', this.formData.isPublic);
                formData.append('featured', this.formData.featured);
                formData.append('allow_comments', this.formData.allowComments);
                formData.append('allow_download', this.formData.allowDownload);
                if (this.formData.groupId) {
                    formData.append('group_id', this.formData.groupId);
                }
                formData.append('tags', JSON.stringify(this.formData.tags));

                // Simulate upload progress
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        this.uploadProgress = Math.round((e.loaded / e.total) * 100);
                        this.uploadStatus = `Uploading... ${this.uploadProgress}%`;
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        this.uploadProgress = 100;
                        this.uploadStatus = 'Processing video...';

                        setTimeout(() => {
                            this.uploading = false;
                            this.uploadSuccess = true;
                            showToast('Video uploaded successfully!', 'success');
                        }, 1000);
                    } else {
                        throw new Error('Upload failed');
                    }
                });

                xhr.addEventListener('error', () => {
                    throw new Error('Network error during upload');
                });

                xhr.open('POST', '/api/videos/upload', true);
                xhr.send(formData);

            } catch (error) {
                this.uploading = false;
                this.uploadError = true;
                this.errorMessage = error.message || 'An error occurred during upload';
                showToast('Upload failed: ' + this.errorMessage, 'error');
            }
        }
    }
}
</script>
{% endblock %}
