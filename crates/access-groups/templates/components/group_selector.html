{# Group Selector Component #}
{# Usage: Include this template in upload forms to allow selecting a group #}
{# Pass 'user_groups' variable with list of groups the user can upload to #}

<div class="form-control">
    <label class="label">
        <span class="label-text font-semibold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
            </svg>
            Share with Group
        </span>
        <span class="label-text-alt text-base-content/60">(Optional)</span>
    </label>

    <select name="group_id" id="groupSelector" class="select select-bordered w-full">
        <option value="">Personal (Private)</option>
        <option disabled>──</option>────────</option>

        {% if user_groups.is_empty() %}
        <option disabled>No groups available</option>
        <option disabled>Create a group to share with your team</option>
        {% else %}
        {% for group in user_groups %}
            {% if group.user_role == "owner" || group.user_role == "admin" || group.user_role == "editor" || group.user_role == "contributor" %}
            <option value="{{ group.group.id }}"
                    data-role="{{ group.user_role }}"
                    data-slug="{{ group.group.slug }}"
                    {% if selected_group_id == group.group.id %}selected{% endif %}>
                {{ group.group.name }}
                <span class="text-xs opacity-60">({{ group.user_role }})</span>
            </option>
            {% endif %}
        {% endfor %}
        {% endif %}
    </select>

    <label class="label">
        <span class="label-text-alt text-base-content/60 flex items-start gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <span id="groupHelp">
                {% if user_groups.is_empty() %}
                Upload to your personal library or <a href="/groups/create" class="link link-primary">create a group</a> to collaborate
                {% else %}
                Share with a group or keep it private in your personal library
                {% endif %}
            </span>
        </span>
    </label>
</div>

<script>
// Group selector dynamic help text
document.getElementById('groupSelector')?.addEventListener('change', function() {
    const helpText = document.getElementById('groupHelp');
    const selected = this.options[this.selectedIndex];
    const role = selected.dataset.role;

    if (!this.value) {
        helpText.innerHTML = 'Upload to your personal library or <a href="/groups/create" class="link link-primary">create a group</a> to collaborate';
    } else if (role) {
        const groupName = selected.text.split('(')[0].trim();
        let permissions = '';

        switch(role) {
            case 'owner':
            case 'admin':
            case 'editor':
                permissions = 'All members can view, editors can manage';
                break;
            case 'contributor':
                permissions = 'All members can view, you can upload';
                break;
            default:
                permissions = 'Group members will be able to view this';
        }

        helpText.innerHTML = `Sharing with <strong>${groupName}</strong> - ${permissions}`;
    }
});

// Pre-select group from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const groupParam = urlParams.get('group');
if (groupParam) {
    const selector = document.getElementById('groupSelector');
    const option = Array.from(selector.options).find(opt =>
        opt.dataset.slug === groupParam
    );
    if (option) {
        option.selected = true;
        selector.dispatchEvent(new Event('change'));
    }
}
</script>

<style>
/* Enhanced select styling */
#groupSelector option[disabled] {
    color: var(--bc) / 0.4;
    font-style: italic;
}

#groupSelector option[data-role] {
    padding-left: 0.5rem;
}

#groupSelector option[value=""] {
    font-weight: 600;
}
</style>
